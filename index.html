<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ChispaLive ‚Äî Demo</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#ff2e6a;
      --bg:#0b1220;
      --card:#0f1a2b;
      --line:#1b3150;
      --text:#e9f6ff;
      --sub:#9bc2df;
      --ok:#27ae60;
      --warn:#ffb020;
      --vip:#ffd54d;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Poppins,system-ui,sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:1100px;margin:0 auto;padding:16px}

    /* ====== Header ====== */
    .header{position:sticky;top:0;z-index:50;background:rgba(10,18,32,.85);backdrop-filter:blur(6px);border-bottom:1px solid #132338}
    .header-inner{display:flex;justify-content:space-between;align-items:center;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .btn{border:0;padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer;transition:.15s;font-size:14px}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-ghost{background:transparent;color:#cfe7ff;border:1px solid #244362}
    .btn-warning{background:var(--warn);color:#1b1407}
    .input{width:100%;background:#0e192a;color:#d9eeff;border:1px solid #1f3550;border-radius:12px;padding:10px 12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 10px 32px rgba(0,0,0,.35)}
    .small{color:var(--sub);font-size:12px}
    .view{display:none}.view.active{display:block}

    /* ====== Monedas badge ====== */
    .coins-badge{
      display:inline-flex;align-items:center;gap:6px;
      background:#0e192a;border:1px solid #233f60;padding:6px 10px;border-radius:999px;
      font-weight:700
    }
    .coins-badge img{height:18px;width:18px;object-fit:contain;display:block}

    /* ====== T√≠tulo animado ====== */
    .title-hero{
      font-weight:800;font-size:22px;margin:10px 0 0 0;
      display:inline-flex;align-items:center;gap:8px;
      background:linear-gradient(90deg,#fff,#ffd1dc,#fff);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      animation:shine 2.4s linear infinite, pulseZoom 3.8s ease-in-out infinite;
      text-shadow:0 0 18px rgba(255,255,255,.12);
    }
    @keyframes shine{0%{filter:brightness(1)}50%{filter:brightness(1.25)}100%{filter:brightness(1)}}
    @keyframes pulseZoom{0%,100%{transform:scale(1)}50%{transform:scale(1.04)}}

    /* ====== Modelos ====== */
    .model-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px;margin-top:18px}
    .model-card{background:#fff;color:#000;border-radius:14px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.12);display:flex;flex-direction:column;cursor:pointer;transition:transform .25s, box-shadow .25s;animation:softFloat 4s ease-in-out infinite}
    .model-card:hover{transform:translateY(-4px) scale(1.02);box-shadow:0 12px 30px rgba(0,0,0,.2)}
    @keyframes softFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .model-slideshow{position:relative;height:200px}
    .model-slideshow img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .6s ease}
    .model-slideshow img.active{opacity:1}
    .model-card .info{padding:12px;display:flex;flex-direction:column;gap:6px}
    .model-card .name{font-weight:700;font-size:16px;color:#111}
    .model-card .extra{font-size:12px;color:#555}
    .model-card .desc{font-size:13px;color:#333}
    .model-card .online{display:inline-block;background:var(--ok);color:#fff;font-size:12px;padding:2px 6px;border-radius:6px;margin-left:6px}
    .model-card .actions{display:flex;gap:10px;justify-content:space-between;align-items:center;padding:10px 12px;background:#f7f9fb;border-top:1px solid #eaeef3}
    .action-btn{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid #e0e6ee;background:#fff;cursor:pointer;transition:.2s;font-weight:600;font-size:13px;color:#222}
    .action-btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.08)}
    .action-btn img{width:18px;height:18px;display:block}
    .like-badge{background:var(--brand);color:#fff;font-size:12px;padding:2px 8px;border-radius:999px}

    /* ====== Banner Video ====== */
    .banner-wrap{position:relative;margin-top:8px}
    .banner-wrap video{width:100%;max-height:180px;object-fit:cover;border-radius:14px;display:block}
    .live-badge{position:absolute;top:12px;left:12px;background:#001f99;color:#fff;font-weight:700;font-size:14px;padding:6px 12px;border-radius:10px;animation:pulse 1.5s infinite;box-shadow:0 0 8px rgba(0,0,0,.4)}
    @keyframes pulse{0%{transform:scale(1);opacity:1}50%{transform:scale(1.1);opacity:.85}100%{transform:scale(1);opacity:1}}

    /* ====== Chat ====== */
    .chat-card{height:calc(100vh - 80px);display:flex;flex-direction:column}
    .chat-head{display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--line);padding:10px;background:var(--card)}
    .chat-head .name{font-weight:700}
    .chat-body{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;padding:10px 2px}
    .msg{max-width:70%;padding:10px 14px;border-radius:18px;line-height:1.35;font-size:15px;animation:floatIn .25s ease}
    .msg.you{align-self:flex-end;background:#12253c}
    .msg.them{align-self:flex-start;background:#0c1728}
    .msg .meta{margin-top:6px;font-size:11px;color:#86a9c7}
    .typing{color:#99c7ff;font-size:12px;padding:6px 0;display:none}
    .typing.on{display:block}
    .chat-input{display:flex;gap:8px;align-items:center;padding:10px;border-top:1px solid var(--line);background:var(--card)}
    .chat-input .input{flex:1}
    .emoji-vip{display:flex;gap:6px;flex-wrap:wrap}

    /* ====== Interstitial ====== */
    .interstitial{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;place-items:center;z-index:2000}
    .interstitial.show{display:grid}
    .interstitial .inner{background:var(--card);border:1px solid var(--line);border-radius:18px;overflow:hidden;width:min(640px,95vw)}
    .interstitial .bar{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-top:1px solid var(--line)}
    .countdown{font-size:12px;opacity:.8;margin-right:auto;margin-left:8px}

    /* ====== Toasts ====== */
    .toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:10px;z-index:3000}
    .toast{background:#0e1a2a;color:#d8ecff;border:1px solid #27507c;padding:12px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);animation:floatIn .25s ease;display:flex;align-items:flex-start;gap:8px}
    .toast.ok{border-color:#2f7c4b}
    .toast.warn{border-color:#7c5b2f}
    .toast .title{font-weight:700;margin-bottom:4px}
    .toast .close{margin-left:auto;background:transparent;border:0;color:#cfe7ff;cursor:pointer}

    /* ====== MODALES ====== */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.75);
      display: none;
      place-items: center;
      z-index: 3000;
    }
    .modal.show {
      display: grid;
    }
    .modal .content {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 20px;
      width: min(420px, 95%);
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 12px 32px rgba(0,0,0,.5);
      opacity: 0; transform: scale(.96);
      animation: modalIn .18s ease forwards;
    }
    @keyframes modalIn {
      to { opacity: 1; transform: scale(1); }
    }

    /* Elementos dentro de modales */
    .price-pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid #294a72;background:#0f1a2b;color:#e9f6ff;font-weight:700;font-size:13px
    }
    .grid-buttons{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:#9bc2df}
    .vip-hero{
      display:flex;gap:10px;align-items:center;margin:0 0 8px;font-weight:800;font-size:18px
    }
  </style>

  <!-- PayPal SDK (se carga din√°micamente en JS) -->
  <script id="paypal-sdk-loader"></script>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="header-inner container">
      <div class="brand">
        <img id="appLogo" src="https://qu.ax/PyOjt.png" alt="Logo" style="height:36px;border-radius:8px;object-fit:contain">
        <span>ChispaLive</span>
      </div>

      <nav style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button class="btn btn-ghost" id="btnMissions">üóìÔ∏è Misiones</button>
        <button class="btn btn-primary" id="btnStore">üí≥ Tienda</button>
        <button class="btn btn-ghost" id="btnVIP">üíé VIP</button>

        <!-- Monedas -->
        <div id="coinsBox" class="coins-badge" title="Tus moneditas">
          <img id="coinsIcon" src="" alt="Coins">
          <span id="coinsLabel">0</span>
        </div>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- BANNER VIDEO -->
    <div class="banner-wrap">
      <a id="bannerLink" href="#" target="_blank" rel="noopener">
        <video autoplay muted loop playsinline>
          <source id="bannerVideoSrc" src="" type="video/mp4">
          Tu navegador no soporta video.
        </video>
        <div class="live-badge">üî¥ En directo</div>
      </a>
    </div>

    <!-- LISTA DE MODELOS -->
    <section id="view-chat" class="view active">
      <h3 class="title-hero">Chatea en vivo ü•∞</h3>
      <div class="model-grid" id="chatList"></div>
    </section>

    <!-- CHAT -->
    <section id="view-conversation" class="view">
      <div class="card chat-card">
        <div class="chat-head">
          <button class="btn btn-ghost" id="btnBack">‚Üê Volver</button>
          <img id="chatAvatar" src="" style="width:40px;height:40px;border-radius:50%;object-fit:cover">
          <div>
            <div id="chatName" class="name"></div>
            <small id="chatStatus" class="small">En l√≠nea</small>
          </div>
          <div style="margin-left:auto" class="coins-badge">
            <img id="coinsIcon2" src="" alt="Coins">
            <b id="coinsLabel2">0</b>
          </div>
        </div>
        <div class="chat-body" id="messages"></div>
        <div class="typing" id="typingHint">Est√° escribiendo‚Ä¶</div>
        <div class="chat-input">
          <input class="input" id="msgText" placeholder="Escribe un mensaje (2 monedas / ilimitado si VIP)"/>
          <div class="emoji-vip" id="vipEmojis" title="Emojis VIP (requiere VIP)" style="display:none">
            <button class="btn btn-ghost" data-emoji="üíã">üíã</button>
            <button class="btn btn-ghost" data-emoji="üî•">üî•</button>
            <button class="btn btn-ghost" data-emoji="üíé">üíé</button>
          </div>
          <button class="btn btn-primary" id="btnSend">Enviar</button>
        </div>
      </div>
    </section>
  </main>

  <!-- ========== MODALES ========== -->

  <!-- RECARGA AUTOR√ÅPIDA cuando faltan monedas -->
  <div id="rechargeModal" class="modal">
    <div class="content">
      <h3 style="margin:0 0 6px">Sin monedas üò¢</h3>
      <p class="small">Cada mensaje cuesta <b>2</b> moneditas.</p>

      <div class="grid-buttons" style="margin-bottom:8px">
        <button class="btn btn-primary s-buy-coins" data-amount="50" data-price="0.50">50 ‚Äî $0.50</button>
        <button class="btn btn-primary s-buy-coins" data-amount="150" data-price="1.50">150 ‚Äî $1.50</button>
        <button class="btn btn-primary s-buy-coins" data-amount="400" data-price="4.00">400 ‚Äî $4.00</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin:8px 0 10px">
        <span class="muted">¬øPrefieres ver todo?</span>
        <button class="btn btn-ghost" id="goToStoreFromRecharge">Abrir Tienda</button>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-ghost" id="btnCloseModal">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- TIENDA (solo MONEDAS) -->
  <div id="storeModal" class="modal">
    <div class="content">
      <h3 style="margin:0 0 6px">Tienda</h3>
      <p class="small">Compra moneditas para seguir chateando.</p>

      <div class="grid-buttons" style="margin-bottom:8px">
        <button class="btn btn-primary s-buy-coins" data-amount="50" data-price="0.50">50 ‚Äî $0.50</button>
        <button class="btn btn-primary s-buy-coins" data-amount="150" data-price="1.50">150 ‚Äî $1.50</button>
        <button class="btn btn-primary s-buy-coins" data-amount="400" data-price="4.00">400 ‚Äî $4.00</button>
      </div>

      <div id="paypal-store-wrap" style="display:none;margin-top:10px">
        <div class="small" id="paypal-store-caption" style="margin:6px 0 8px"></div>
        <div id="paypal-store-btn"></div>
      </div>

      <div style="margin-top:10px">
        <button class="btn btn-ghost" id="btnCloseStore">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- VIP (solo PLANES) -->
  <div id="vipModal" class="modal">
    <div class="content">
      <div class="vip-hero">üíé Hazte VIP y desbloquea todo</div>
      <p class="small" style="margin:0 0 10px">
        ‚úÖ Chat ilimitado ¬∑ üì∏ Fotos privadas ¬∑ ‚ú® Emojis exclusivos
      </p>

      <div class="grid-buttons" style="margin-bottom:8px">
        <button class="btn btn-ghost vip-plan" data-plan="24h" data-price="4">VIP 24h ‚Äî $4</button>
        <button class="btn btn-ghost vip-plan" data-plan="7d" data-price="15">VIP 1 semana ‚Äî $15</button>
        <button class="btn btn-ghost vip-plan" data-plan="30d" data-price="30">VIP 1 mes ‚Äî $30</button>
      </div>

      <div id="paypal-vip-wrap" style="display:none;margin-top:10px">
        <div class="small" id="paypal-vip-caption" style="margin:6px 0 8px"></div>
        <div id="paypal-vip-btn"></div>
      </div>

      <div style="margin-top:12px">
        <button class="btn btn-ghost" id="btnCloseVIP">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- MISIONES DIARIAS -->
  <div id="missionsModal" class="modal">
    <div class="content">
      <h3 style="margin:0 0 6px">Misiones diarias</h3>

      <div class="card">
        <b>1) Seguir estas cuentas de Facebook (+20)</b>
        <div class="grid-buttons" style="margin-top:8px">
          <a class="btn btn-ghost" id="fb1" target="_blank" rel="noopener">
            <img id="fb1logo" src="" alt="fb" style="height:16px;vertical-align:-3px;margin-right:6px"> P√°gina 1
          </a>
          <a class="btn btn-ghost" id="fb2" target="_blank" rel="noopener">
            <img id="fb2logo" src="" alt="fb" style="height:16px;vertical-align:-3px;margin-right:6px"> P√°gina 2
          </a>
          <a class="btn btn-ghost" id="fb3" target="_blank" rel="noopener">
            <img id="fb3logo" src="" alt="fb" style="height:16px;vertical-align:-3px;margin-right:6px"> P√°gina 3
          </a>
        </div>
        <button class="btn btn-primary" id="btnMissionFollow" style="margin-top:8px">Marcar como hecho (+20)</button>
      </div>

      <div class="card" style="margin-top:12px">
        <b>2) Reaccionar a 3 fotos de cada cuenta (+10)</b>
        <p class="small" style="margin:6px 0">Haz like/‚ù§Ô∏è en 3 publicaciones por cuenta. Enlaces:</p>
        <ul class="small" style="margin:0 0 8px 18px;line-height:1.5">
          <li><a id="fbp1" href="#" target="_blank" rel="noopener">P√°gina 1 ‚Äî publicaciones</a></li>
          <li><a id="fbp2" href="#" target="_blank" rel="noopener">P√°gina 2 ‚Äî publicaciones</a></li>
          <li><a id="fbp3" href="#" target="_blank" rel="noopener">P√°gina 3 ‚Äî publicaciones</a></li>
        </ul>
        <button class="btn btn-primary" id="btnMissionReact">Marcar como hecho (+10)</button>
      </div>

      <div style="margin-top:12px">
        <button class="btn btn-ghost" id="btnCloseMissions">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- INTERSTITIAL OVERLAY (previa al chat) -->
  <div id="interstitialOverlay" class="interstitial">
    <div class="inner">
      <!-- Puedes colocar aqu√≠ el script de tu red de interstitial si quieres -->
      <div class="bar">
        <span class="small">Publicidad ‚Äî Interstitial</span>
        <span class="countdown" id="interCounter">Esperando‚Ä¶</span>
        <button id="closeInterstitial" class="btn btn-ghost" style="display:none">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- TOASTS -->
  <div class="toast-wrap" id="toasts"></div>

  <script type="module">
/* =======================
   CONFIGURACI√ìN R√ÅPIDA
========================*/
const PAYPAL_CLIENT_ID = 'TU_CLIENT_ID_PAYPAL_LIVE'; // <-- Reemplaza por tu Client ID real

// √çconos/URLs
const COIN_ICON_URL = 'https://i.imgur.com/5o8w7oS.png';
const VIP_ICON_URL  = 'https://i.imgur.com/1F2r0yN.png';
const FACEBOOK_ICON_URL = 'https://i.imgur.com/6c1mQw6.png';
const PRIV_ICON_URL = 'https://i.imgur.com/Q8oQH0x.png';

const BANNER_LINK  = 'https://tu-enlace-del-banner.com';
const BANNER_VIDEO = 'https://qu.ax/dMvpz.mp4';

// Misiones: logos y enlaces
const FB_MISSIONS = [
  { logo: FACEBOOK_ICON_URL, url: 'https://facebook.com/pagina1', posts: 'https://facebook.com/pagina1/posts' },
  { logo: FACEBOOK_ICON_URL, url: 'https://facebook.com/pagina2', posts: 'https://facebook.com/pagina2/posts' },
  { logo: FACEBOOK_ICON_URL, url: 'https://facebook.com/pagina3', posts: 'https://facebook.com/pagina3/posts' }
];

// Cargar SDK de PayPal din√°micamente
(function loadPayPal(){
  const s=document.getElementById('paypal-sdk-loader');
  s.src = `https://www.paypal.com/sdk/js?client-id=${encodeURIComponent(PAYPAL_CLIENT_ID)}&currency=USD`;
})();

/* ================= FIREBASE (solo lectura modelos) ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAlWJTeezvz0Xkd363SgN5CnHFbEp8uNQU",
  authDomain: "chispalive-b7ed6.firebaseapp.com",
  projectId: "chispalive-b7ed6",
  storageBucket: "chispalive-b7ed6.appspot.com",
  messagingSenderId: "334811479289",
  appId: "1:334811479289:web:403a2a1b10f7af6704b628",
  measurementId: "G-60ERX1MFT7"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= SESI√ìN / ECONOM√çA ================= */
const START_COINS = 50;
const COIN_PER_MSG = 2;

const coinsLabel  = document.getElementById('coinsLabel');
const coinsLabel2 = document.getElementById('coinsLabel2');
const coinsIcon   = document.getElementById('coinsIcon');
const coinsIcon2  = document.getElementById('coinsIcon2');
const vipEmojis   = document.getElementById('vipEmojis');

let session = JSON.parse(localStorage.getItem('session')||'{}');
if(!session.alias){ session = { alias:'Usuario', coins: START_COINS }; saveSession(); }
let membership = JSON.parse(localStorage.getItem('membership')||'null');

function saveSession(){ localStorage.setItem('session', JSON.stringify(session)); }
function updateCoins(delta){
  session.coins = Math.max(0,(session.coins||0)+delta);
  saveSession();
  coinsLabel.textContent=session.coins; coinsLabel2.textContent=session.coins;
}
function isVIP(){ return membership && Date.now() < membership.until; }
function setVIP(duration){
  const now = Date.now();
  const add = duration==='24h'? 24*3600e3 : duration==='7d'? 7*24*3600e3 : 30*24*3600e3;
  membership = { until: now + add };
  localStorage.setItem('membership', JSON.stringify(membership));
  paintVIP();
  toast('VIP ACTIVADO ‚ú®','Disfruta chat ilimitado y fotos privadas.','ok');
}
function paintVIP(){
  const active = isVIP();
  if(vipEmojis) vipEmojis.style.display = active ? 'flex' : 'none';
  const icon = active ? VIP_ICON_URL : COIN_ICON_URL;
  coinsIcon.src = icon; coinsIcon2.src = icon;
}
updateCoins(0); paintVIP();

/* ================= Banner config ================= */
document.getElementById('bannerLink').href = BANNER_LINK;
document.getElementById('bannerVideoSrc').src = BANNER_VIDEO;

/* ================= Misiones ================= */
const missionsModal = document.getElementById('missionsModal');
document.getElementById('btnMissions').onclick = ()=> missionsModal.classList.add('show');
document.getElementById('btnCloseMissions').onclick = ()=> missionsModal.classList.remove('show');

document.getElementById('fb1').href = FB_MISSIONS[0].url;
document.getElementById('fb2').href = FB_MISSIONS[1].url;
document.getElementById('fb3').href = FB_MISSIONS[2].url;
document.getElementById('fb1logo').src = FB_MISSIONS[0].logo;
document.getElementById('fb2logo').src = FB_MISSIONS[1].logo;
document.getElementById('fb3logo').src = FB_MISSIONS[2].logo;
// Enlaces de publicaciones (Misi√≥n 2)
document.getElementById('fbp1').href = FB_MISSIONS[0].posts;
document.getElementById('fbp2').href = FB_MISSIONS[1].posts;
document.getElementById('fbp3').href = FB_MISSIONS[2].posts;

const todayKey = ()=> 'missions_'+new Date().toISOString().slice(0,10);
function missionState(){ return JSON.parse(localStorage.getItem(todayKey())||'{"follow":false,"react":false}'); }
function setMission(key){ const s=missionState(); s[key]=true; localStorage.setItem(todayKey(), JSON.stringify(s)); }

document.getElementById('btnMissionFollow').onclick = ()=>{
  const s=missionState();
  if(s.follow) return toast('Ya completaste esta misi√≥n','Vuelve ma√±ana.','warn');
  updateCoins(20); setMission('follow');
  toast('+20 moneditas','Gracias por seguir las cuentas.','ok');
};
document.getElementById('btnMissionReact').onclick = ()=>{
  const s=missionState();
  if(s.react) return toast('Ya completaste esta misi√≥n','Vuelve ma√±ana.','warn');
  updateCoins(10); setMission('react');
  toast('+10 moneditas','¬°Gracias por reaccionar a las fotos!','ok');
};

/* ================= Toast util ================= */
const toasts = document.getElementById('toasts');
function toast(title,body,type='ok'){
  const el=document.createElement('div');
  el.className=`toast ${type}`;
  el.innerHTML=`
    <div>
      <div class="title">${sanitize(title)}</div>
      <div class="small">${sanitize(body)}</div>
    </div>
    <button class="close">√ó</button>
  `;
  toasts.appendChild(el);
  el.querySelector('.close').onclick=()=>el.remove();
  setTimeout(()=>{ if(el.parentNode) el.remove(); }, 6000);
}
function sanitize(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

/* ================= MODALES UTIL ================= */
function openModal(id){ document.getElementById(id).classList.add('show'); }
function closeModal(id){ document.getElementById(id).classList.remove('show'); }

/* Abridores header */
document.getElementById('btnStore').onclick = ()=> openModal('storeModal');
document.getElementById('btnVIP').onclick   = ()=> openModal('vipModal');

/* Cerradores */
document.getElementById('btnCloseModal').onclick = ()=> closeModal('rechargeModal');
document.getElementById('btnCloseStore').onclick = ()=> closeModal('storeModal');
document.getElementById('btnCloseVIP').onclick   = ()=> closeModal('vipModal');
document.getElementById('goToStoreFromRecharge').onclick = ()=>{
  closeModal('rechargeModal'); openModal('storeModal');
};

/* ================= PAYPAL RENDER ================= */
function ensurePayPal(cb){
  let tries=0;
  const iv=setInterval(()=>{
    tries++;
    if(window.paypal){ clearInterval(iv); cb(); }
    else if(tries>60){ clearInterval(iv); toast('PayPal no carg√≥','Revisa tu Client ID en el c√≥digo.','warn'); }
  },250);
}

function renderPayPalButton({price, onApprove, containerId}){
  ensurePayPal(()=>{
    const container = document.getElementById(containerId);
    container.innerHTML = ''; // limpiar si ya hab√≠a uno
    window.paypal.Buttons({
      style:{ layout:'horizontal', shape:'pill', label:'paypal', tagline:false },
      createOrder: (data, actions)=> actions.order.create({
        purchase_units: [{ amount: { value: String(price) } }]
      }),
      onApprove: async (data, actions)=>{
        try{
          await actions.order.capture();
          onApprove();
        }catch(e){ toast('Pago no capturado','Int√©ntalo de nuevo.','warn'); }
      },
      onError: ()=> toast('Error en PayPal','Verifica tu cuenta o conexi√≥n.','warn')
    }).render('#'+containerId);
  });
}

/* Monedas: al elegir paquete */
function selectCoinsPackage(amount, price){
  document.getElementById('paypal-store-wrap').style.display='block';
  document.getElementById('paypal-store-caption').textContent = `Pagar $${Number(price).toFixed(2)} por ${amount} monedas`;
  renderPayPalButton({
    price,
    containerId:'paypal-store-btn',
    onApprove: ()=>{
      updateCoins(Number(amount));
      toast('Compra exitosa','Se acreditaron tus moneditas.','ok');
      closeModal('storeModal');
    }
  });
}

/* VIP: al elegir plan */
function selectVIPPlan(plan, price){
  document.getElementById('paypal-vip-wrap').style.display='block';
  const planLabel = plan==='24h'?'24 horas':(plan==='7d'?'1 semana':'1 mes');
  document.getElementById('paypal-vip-caption').textContent = `Activar VIP (${planLabel}) por $${Number(price).toFixed(2)}`;
  renderPayPalButton({
    price,
    containerId:'paypal-vip-btn',
    onApprove: ()=>{
      setVIP(plan);
      closeModal('vipModal');
    }
  });
}

/* Delegaci√≥n: botones de paquetes y VIP */
document.addEventListener('click', (e)=>{
  const coinBtn = e.target.closest('.s-buy-coins');
  if(coinBtn){
    const amount = coinBtn.getAttribute('data-amount');
    const price  = coinBtn.getAttribute('data-price');
    // Si viene desde rechargeModal, abrimos Tienda con el paquete ya seleccionado.
    openModal('storeModal');
    document.getElementById('paypal-store-wrap').style.display='none';
    selectCoinsPackage(amount, price);
  }

  const vipBtn = e.target.closest('.vip-plan');
  if(vipBtn){
    const plan  = vipBtn.getAttribute('data-plan');
    const price = vipBtn.getAttribute('data-price');
    document.getElementById('paypal-vip-wrap').style.display='none';
    selectVIPPlan(plan, price);
  }
});

/* ================= MODELOS ================= */
const chatList=document.getElementById('chatList');
const slidesIntervals={};

async function renderModels(){
  chatList.innerHTML='';
  const snap = await getDocs(collection(db,"models"));
  snap.forEach(docSnap=>{
    const m={id:docSnap.id,...docSnap.data()};
    const card=document.createElement('div');
    card.className='model-card';

    const slideId='slide_'+m.id;
    const pub = (m.photos||[]).slice(0,3);
    const priv = (m.photos||[]).slice(3,5);

    card.innerHTML=`
      <div class="model-slideshow" id="${slideId}">
        ${pub.map((src,i)=>`<img src="${src}" class="${i===0?'active':''}">`).join('')}
      </div>
      <div class="info">
        <div class="name">${sanitize(m.name||'Modelo')} <span class="online">‚óè Online</span></div>
        <div class="extra">${m.age||'‚Äî'} a√±os ¬∑ ${sanitize(m.country||'‚Äî')}</div>
        <div class="desc">${sanitize(m.desc||'')}</div>
      </div>
      <div class="actions">
        <button class="action-btn btn-like" title="Me gusta">
          <img src="https://qu.ax/hlsxX.png" alt="like"><span>Me gusta</span>
          <span class="like-badge">${m.likes||0}</span>
        </button>
        <a class="action-btn btn-fb" ${m.facebookUrl?`href="${m.facebookUrl}" target="_blank" rel="noopener"`:'style="pointer-events:none;opacity:.5"'} title="Facebook">
          <img src="${FACEBOOK_ICON_URL}" alt="fb"><span>Facebook</span>
        </a>
        <button class="action-btn btn-priv" title="Ver privadas">
          <img src="${PRIV_ICON_URL}" alt="priv"><span>Privadas</span>
        </button>
        <button class="action-btn btn-msg" title="Enviar mensaje">
          <img src="https://qu.ax/jGSiu.png" alt="mensaje"><span>Mensaje</span>
        </button>
      </div>
    `;

    // Eventos de acciones
    card.querySelector('.btn-like').onclick=(ev)=>{
      ev.stopPropagation();
      const badge=card.querySelector('.like-badge');
      badge.textContent = Number(badge.textContent||0)+1;
    };

    card.querySelector('.btn-msg').onclick=()=> showInterstitialBeforeChat(m);

    card.querySelector('.btn-priv').onclick=(e)=>{
      e.stopPropagation();
      if(!isVIP()){ toast('Activa VIP','Para ver las privadas üòè','warn'); return; }
      const w = window.open('','_blank','width=800,height=600');
      (priv.length?priv:pub).forEach(src=> w.document.write(`<img src="${src}" style="width:100%;margin-bottom:8px">`));
    };

    // Agregar card + slideshow
    chatList.appendChild(card);
    startSlideshow(slideId);
  });
}

function startSlideshow(id){
  const box=document.getElementById(id); if(!box) return;
  const imgs=[...box.querySelectorAll('img')]; if(imgs.length<=1) return;
  let i=0;
  if(slidesIntervals[id]) clearInterval(slidesIntervals[id]);
  slidesIntervals[id]=setInterval(()=>{
    imgs[i].classList.remove('active');
    i=(i+1)%imgs.length;
    imgs[i].classList.add('active');
  }, 2800);
}

/* ================= INTERSTITIAL ================= */
const interstitial = document.getElementById('interstitialOverlay');
const closeInterstitial = document.getElementById('closeInterstitial');
const interCounter = document.getElementById('interCounter');
let nextModel = null;
let interTimer = null;
let interOpen = false;

function showInterstitialBeforeChat(m){
  if(interOpen) return;
  interOpen = true;
  nextModel = m;
  interstitial.classList.add('show');
  closeInterstitial.style.display='none';
  let sec=4;
  interCounter.textContent = `Cierra disponible en ${sec}s`;
  clearInterval(interTimer);
  interTimer = setInterval(()=>{
    sec--;
    if(sec>0){
      interCounter.textContent = `Cierra disponible en ${sec}s`;
    }else{
      clearInterval(interTimer);
      interCounter.textContent = '';
      closeInterstitial.style.display='inline-block';
    }
  },1000);
}
closeInterstitial.onclick=()=>{
  interstitial.classList.remove('show');
  interOpen = false;
  if(nextModel) openChatWith(nextModel);
  nextModel=null;
};

/* ================= CHAT ================= */
let currentModel=null;
const messages=document.getElementById('messages');
const chatName=document.getElementById('chatName');
const chatAvatar=document.getElementById('chatAvatar');
const chatStatus=document.getElementById('chatStatus');
const typingHint=document.getElementById('typingHint');

function openChatWith(m){
  currentModel=m;
  chatName.textContent=m.name||'Modelo';
  chatAvatar.src=(m.photos&&m.photos[0])||'';
  chatStatus.textContent='En l√≠nea';
  messages.innerHTML=`<div class="msg them">Holi üíñ soy ${sanitize(m.name||'yo')}, ¬øquieres jugar cari√±o?</div>`;
  go('conversation');
}

function go(v){
  document.getElementById('view-chat').classList.toggle('active', v==='chat');
  document.getElementById('view-conversation').classList.toggle('active', v==='conversation');
}

document.getElementById('btnBack').onclick=()=> go('chat');

document.getElementById('btnSend').onclick=sendMsg;
document.getElementById('msgText').addEventListener('keydown',e=>{ if(e.key==='Enter'){e.preventDefault();sendMsg();} });

function sendMsg(){
  if(!currentModel) return;
  const input=document.getElementById('msgText');
  const val=(input.value||'').trim(); if(!val) return;

  if(!isVIP()){
    if((session.coins||0) < COIN_PER_MSG){ openModal('rechargeModal'); return; }
    updateCoins(-COIN_PER_MSG);
  }

  const ts=Date.now();
  messages.innerHTML+=`<div class="msg you">${sanitize(val)}<div class="meta">${new Date(ts).toLocaleTimeString()} ¬∑ enviado</div></div>`;
  input.value='';

  typing(true);
  setTimeout(()=>{
    typing(false);
    autoReply(val);
  },1600);
}

/* ================= BOT RESPUESTAS ================ */
function autoReply(userText){
  const lower = userText.toLowerCase();
  let reply;

  if(/(hola|buenas|hey|ola|holii|holaaa)/i.test(lower)){
    reply = `¬°Holi amor üòò! Soy ${sanitize(currentModel?.name||'‚ù§Ô∏è')}, cu√©ntame algo bonito ‚ù§Ô∏è`;
  }else if(/(edad|a√±os)/i.test(lower)){
    reply = `Tengo ${sanitize(currentModel?.age||'22')} a√±itos üòú mi rey`;
  }else if(/(foto|privada)/i.test(lower)){
    reply = isVIP()
      ? `Tengo unas fotos üî• solo para ti beb√© üòè`
      : `Activa VIP y te ense√±o cositas ricas üëë`;
  }else if(/(d√≥nde|pais|pa√≠s)/i.test(lower)){
    reply = `Soy de ${sanitize(currentModel?.country||'un lugar calientito')} ‚òÄÔ∏è ¬øy t√∫, mi pr√≠ncipe?`;
  }else if(/(novia|relaci√≥n|salir)/i.test(lower)){
    reply = `Uff papasito üòà dime... ¬øbuscas amor o travesuras?`;
  }else{
    reply = `Mmm me encanta cuando hablas as√≠ üòç sigue‚Ä¶`;
  }

  messages.innerHTML+=`<div class="msg them">${reply}<div class="meta">${new Date().toLocaleTimeString()}</div></div>`;
}

/* INIT */
renderModels();
  </script>
</body>
</html>

