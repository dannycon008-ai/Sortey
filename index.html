<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ChispaLive ‚Äî Demo</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ====== ESTILOS MODELOS (RESPETA TU LOOK) ====== */
    .model-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px;margin-top:18px}
    .model-card{background:#fff;color:#000;border-radius:14px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.12);display:flex;flex-direction:column;cursor:pointer;transition:transform .25s ease,box-shadow .25s ease;animation:softFloat 4s ease-in-out infinite}
    .model-card:hover{transform:translateY(-4px) scale(1.02);box-shadow:0 12px 30px rgba(0,0,0,.2)}
    @keyframes softFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .model-slideshow{position:relative;height:200px}
    .model-slideshow img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .6s ease}
    .model-slideshow img.active{opacity:1}
    .model-card .info{padding:12px;display:flex;flex-direction:column;gap:6px}
    .model-card .name{font-weight:700;font-size:16px;color:#111}
    .model-card .extra{font-size:12px;color:#555}
    .model-card .desc{font-size:13px;color:#333}
    .model-card .online{display:inline-block;background:#27ae60;color:#fff;font-size:12px;padding:2px 6px;border-radius:6px;margin-left:6px}
    .model-card .actions{display:flex;gap:10px;justify-content:space-between;align-items:center;padding:10px 12px;background:#f7f9fb;border-top:1px solid #eaeef3;flex-wrap:wrap}
    .action-btn{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid #e0e6ee;background:#fff;cursor:pointer;transition:.2s;font-weight:600;font-size:13px;color:#222}
    .action-btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.08)}
    .action-btn img{width:18px;height:18px;display:block}
    .like-badge{background:#ff2e6a;color:#fff;font-size:12px;padding:2px 8px;border-radius:999px}

    /* ====== GENERALES ====== */
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:Poppins,system-ui,sans-serif;background:#0b1220;color:#e9f6ff;overflow-x:hidden}
    .container{max-width:1100px;margin:20px auto;padding:16px}
    .header{position:sticky;top:0;z-index:50;background:rgba(10,18,32,.85);backdrop-filter:blur(6px);border-bottom:1px solid #132338}
    .header-inner{display:flex;justify-content:space-between;align-items:center;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    nav.topnav{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{border:0;padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer;transition:.15s;font-size:14px}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:#ff2e6a;color:#fff}
    .btn-ghost{background:transparent;color:#cfe7ff;border:1px solid #244362}
    .btn-warning{background:#ffb020;color:#1b1407}
    .input{width:100%;background:#0e192a;color:#d9eeff;border:1px solid #1f3550;border-radius:12px;padding:10px 12px}
    .card{background:#0f1a2b;border:1px solid #1b3150;border-radius:18px;padding:16px;box-shadow:0 10px 32px rgba(0,0,0,.35)}
    .small{color:#9bc2df;font-size:12px}
    .view{display:none}.view.active{display:block}

    /* ====== MONEDAS CON ICONO ====== */
    .coin{display:inline-flex;align-items:center;gap:6px}
    .coin img{width:18px;height:18px;vertical-align:middle}

    /* ====== BANNER VIDEO ====== */
    .banner-wrap{position:relative;margin-top:8px}
    .banner-wrap video{width:100%;max-height:180px;object-fit:cover;border-radius:14px;display:block}
    .live-badge{position:absolute;top:12px;left:12px;background:#001f99;color:#fff;font-weight:700;font-size:14px;padding:6px 12px;border-radius:10px;animation:pulse 1.5s infinite;box-shadow:0 0 8px rgba(0,0,0,.4)}
    @keyframes pulse{0%{transform:scale(1);opacity:1}50%{transform:scale(1.1);opacity:.85}100%{transform:scale(1);opacity:1}}

    /* ====== CHAT ====== */
    .chat-card{height:calc(100vh - 80px);display:flex;flex-direction:column}
    .chat-head{display:flex;align-items:center;gap:10px;border-bottom:1px solid #1b3150;padding:10px;background:#0f1a2b}
    .chat-head .name{font-weight:700}
    .chat-body{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;padding:10px 2px}
    .msg{max-width:70%;padding:10px 14px;border-radius:18px;line-height:1.35;font-size:15px;animation:floatIn .25s ease}
    .msg.you{align-self:flex-end;background:#12253c}
    .msg.them{align-self:flex-start;background:#0c1728}
    .msg .meta{margin-top:6px;font-size:11px;color:#86a9c7}
    .typing{color:#99c7ff;font-size:12px;padding:6px 0;display:none}
    .typing.on{display:block}
    .chat-input{display:flex;gap:8px;align-items:center;padding:10px;border-top:1px solid #1b3150;background:#0f1a2b}
    .chat-input .input{flex:1}
    .emoji-vip{display:flex;gap:6px;flex-wrap:wrap}
    @keyframes floatIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    /* ====== MODALES ====== */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;z-index:1000}
    .modal.show{display:grid}
    .modal .content{background:#0f1a2b;border:1px solid #1b3150;border-radius:18px;padding:16px;width:min(520px,92vw);box-shadow:0 24px 60px rgba(0,0,0,.45)}

    /* ====== INTERSTITIAL OVERLAY ====== */
    .interstitial{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;place-items:center;z-index:2000}
    .interstitial.show{display:grid}
    .interstitial .inner{background:#0f1a2b;border:1px solid #1b3150;border-radius:18px;overflow:hidden;width:min(640px,95vw)}
    .interstitial .slot{width:100%;height:360px;display:block;background:#0b1424}
    .interstitial .slot iframe,.interstitial .slot img{width:100%;height:100%;display:block;object-fit:cover}
    .interstitial .bar{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-top:1px solid #1b3150}
    .countdown{font-size:12px;opacity:.8;margin-right:auto;margin-left:8px}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="header-inner container">
      <div class="brand">
        <img id="appLogo" src="https://qu.ax/PyOjt.png" alt="Logo" style="height:36px;border-radius:8px;object-fit:contain">
        <span>ChispaLive</span>
      </div>
      <nav class="topnav">
        <span id="vipBadge" class="small" style="display:none;background:#ffd54d;color:#1e1600;padding:4px 8px;border-radius:999px;font-weight:700">VIP ‚ú®</span>
        <button class="btn btn-ghost" id="btnDaily">üéØ MISIONES DIARIAS</button>
        <button class="btn btn-primary" id="btnStore">üí≥ Tienda</button>
        <div class="coin" style="margin-left:6px">
          <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/69/Coin_icon_3.svg/2048px-Coin_icon_3.svg.png" alt="Monedas">
          <b id="coinsLabel">0</b>
        </div>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- BANNER VIDEO -->
    <div class="banner-wrap">
      <a id="bannerLink" href="https://ejemplo.com" target="_blank" rel="noopener">
        <video autoplay muted loop playsinline>
          <source src="https://qu.ax/dMvpz.mp4" type="video/mp4">
          Tu navegador no soporta video.
        </video>
        <div class="live-badge">üî¥ En directo</div>
      </a>
    </div>

    <!-- LISTA DE MODELOS (INICIO) -->
    <section id="view-chat" class="view active">
      <h3>Modelos</h3>
      <div class="model-grid" id="chatList"></div>
    </section>

    <!-- CHAT SOLO (PANTALLA COMPLETA) -->
    <section id="view-conversation" class="view">
      <div class="card chat-card">
        <div class="chat-head">
          <button class="btn btn-ghost" id="btnBack">‚Üê Volver</button>
          <img id="chatAvatar" src="" style="width:40px;height:40px;border-radius:50%;object-fit:cover">
          <div>
            <div id="chatName" class="name"></div>
            <small id="chatStatus" class="small">En l√≠nea</small>
          </div>
          <div style="margin-left:auto" class="coin small">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/69/Coin_icon_3.svg/2048px-Coin_icon_3.svg.png" alt="Monedas">
            <b id="coinsLabel2">0</b>
          </div>
        </div>
        <div class="chat-body" id="messages"></div>
        <div class="typing" id="typingHint">Est√° escribiendo‚Ä¶</div>
        <div class="chat-input">
          <input class="input" id="msgText" placeholder="Escribe un mensaje (2 monedas / ilimitado si VIP)"/>
          <div class="emoji-vip" id="vipEmojis" title="Emojis VIP (requiere VIP)" style="display:none">
            <button class="btn btn-ghost" data-emoji="üíã">üíã</button>
            <button class="btn btn-ghost" data-emoji="üî•">üî•</button>
            <button class="btn btn-ghost" data-emoji="üíé">üíé</button>
          </div>
          <button class="btn btn-primary" id="btnSend">Enviar</button>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL: RECARGA / OFERTA VIP -->
  <div id="rechargeModal" class="modal">
    <div class="content">
      <h3 style="margin:0 0 6px">Sin monedas üò¢</h3>
      <p class="small">Cada mensaje cuesta <b>2</b> moneditas.</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <button class="btn btn-primary" id="btnBuy20">Comprar 20</button>
        <button class="btn btn-primary" id="btnBuy50">Comprar 50</button>
        <button class="btn btn-primary" id="btnBuy100">Comprar 100</button>
        <button class="btn btn-warning" id="btnWatchAd">Ver anuncio (+10)</button>
      </div>
      <div class="card" style="margin-top:8px">
        <b>üíé Suscr√≠bete VIP y chatea sin l√≠mites</b>
        <div class="small" style="opacity:.85;margin:6px 0 10px">Elige tu plan (PayPal):</div>
        <div id="paypal24h_m"></div>
        <div id="paypal7d_m" style="margin-top:8px"></div>
        <div id="paypal30d_m" style="margin-top:8px"></div>
      </div>
      <div style="margin-top:10px">
        <button class="btn btn-ghost" id="btnCloseModal">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: TIENDA DIRECTA -->
  <div id="storeModal" class="modal">
    <div class="content">
      <h3 style="margin:0 0 6px">Tienda</h3>
      <p class="small">Activa VIP con PayPal o compra monedas.</p>
      <div class="card">
        <b>üíé VIP</b>
        <div class="small" style="opacity:.85;margin:6px 0 10px">Selecciona un plan (PayPal):</div>
        <div id="paypal24h"></div>
        <div id="paypal7d" style="margin-top:8px"></div>
        <div id="paypal30d" style="margin-top:8px"></div>
      </div>
      <div class="card" style="margin-top:12px">
        <b>ü™ô Monedas r√°pidas</b>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button class="btn btn-primary" id="sBuy50">50 monedas</button>
          <button class="btn btn-primary" id="sBuy150">150 monedas</button>
          <button class="btn btn-primary" id="sBuy400">400 monedas</button>
        </div>
      </div>
      <div style="margin-top:10px">
        <button class="btn btn-ghost" id="btnCloseStore">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: MISIONES DIARIAS -->
  <div id="missionsModal" class="modal">
    <div class="content">
      <h3 style="margin:0 0 6px">Misiones diarias</h3>

      <div class="card">
        <b>1) Seguir estas cuentas de Facebook (+20)</b>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0">
          <a class="btn btn-ghost" target="_blank" id="fb1"><img src="https://cdn-icons-png.flaticon.com/512/124/124010.png" style="width:16px;height:16px"> Cuenta 1</a>
          <a class="btn btn-ghost" target="_blank" id="fb2"><img src="https://cdn-icons-png.flaticon.com/512/124/124010.png" style="width:16px;height:16px"> Cuenta 2</a>
          <a class="btn btn-ghost" target="_blank" id="fb3"><img src="https://cdn-icons-png.flaticon.com/512/124/124010.png" style="width:16px;height:16px"> Cuenta 3</a>
        </div>
        <button class="btn btn-primary" id="btnClaimFollow">Verifiqu√© y reclamar +20</button>
        <div class="small" id="followStatus" style="margin-top:6px;opacity:.85"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <b>2) Reaccionar a 3 fotos (+10)</b>
        <p class="small" style="opacity:.85;margin:6px 0">Dale ‚ù§Ô∏è a 3 fotos de cualquiera de las cuentas.</p>
        <button class="btn btn-primary" id="btnClaimReact">Reclamar +10</button>
        <div class="small" id="reactStatus" style="margin-top:6px;opacity:.85"></div>
      </div>

      <div style="margin-top:10px"><button class="btn btn-ghost" id="btnCloseMissions">Cerrar</button></div>
    </div>
  </div>

  <!-- INTERSTITIAL OVERLAY (previa / dentro del chat) -->
  <div id="interstitialOverlay" class="interstitial">
    <div class="inner">
      <div class="slot" id="adSlot">
        <!-- Fallback visible si la red no dibuja nada -->
        <a href="https://detoxifylagoonsnugness.com/2086017" target="_blank" rel="noopener">
          <img src="https://picsum.photos/800/360?random=22" alt="Publicidad">
        </a>
      </div>
      <div class="bar">
        <span class="small">Publicidad ‚Äî Interstitial</span>
        <span class="countdown" id="interCounter">Esperando‚Ä¶</span>
        <button id="closeInterstitial" class="btn btn-ghost" style="display:none">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- SDK PAYPAL (sandbox). Cambia client-id por el tuyo si ya lo tienes -->
  <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"></script>

  <script type="module">
    /* ================= FIREBASE (solo lectura de modelos) ================= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAlWJTeezvz0Xkd363SgN5CnHFbEp8uNQU",
      authDomain: "chispalive-b7ed6.firebaseapp.com",
      projectId: "chispalive-b7ed6",
      storageBucket: "chispalive-b7ed6.appspot.com",
      messagingSenderId: "334811479289",
      appId: "1:334811479289:web:403a2a1b10f7af6704b628",
      measurementId: "G-60ERX1MFT7"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ================= CONFIG (logos/urls) ================= */
    const FACEBOOK_ICON_URL = "https://cdn-icons-png.flaticon.com/512/124/124010.png";
    const PRIVATE_ICON_URL  = "https://cdn-icons-png.flaticon.com/512/747/747376.png";
    // Cuentas para misiones:
    const FB_URL_1 = "https://facebook.com/";
    const FB_URL_2 = "https://facebook.com/";
    const FB_URL_3 = "https://facebook.com/";

    // Script real de tu Interstitial (lo cargamos una vez)
    (function injectInterstitialLib(){
      window.peblqx = window.peblqx || function(){};
      const s = document.createElement('script');
      s.setAttribute('data-cfasync','false');
      s.setAttribute('data-clipid','2086017');
      s.async = true;
      s.src = '//detoxifylagoonsnugness.com/in.js';
      s.onerror = ()=> peblqx(17);
      s.onload  = ()=> peblqx(17);
      document.head.appendChild(s);
    })();

    /* ================= SESI√ìN / ECONOM√çA ================= */
    const START_COINS=50, COIN_PER_MSG=2, DAILY_BONUS=10;
    const coinsLabel=document.getElementById('coinsLabel');
    const coinsLabel2=document.getElementById('coinsLabel2');
    const vipBadge=document.getElementById('vipBadge');
    const vipEmojis=document.getElementById('vipEmojis');

    let session=JSON.parse(localStorage.getItem('session')||'{}');
    if(!session.alias){ session={alias:'Usuario',coins:START_COINS}; saveSession(); }
    updateCoins(0);

    let membership=JSON.parse(localStorage.getItem('membership')||'null');
    paintVIP();

    function saveSession(){ localStorage.setItem('session', JSON.stringify(session)); }
    function updateCoins(delta){ session.coins=Math.max(0,(session.coins||0)+delta); saveSession(); coinsLabel.textContent=session.coins; coinsLabel2.textContent=session.coins; }
    function isVIP(){ return membership && Date.now() < membership.until; }
    function setVIP(duration){
      const ms = duration==='24h' ? 24*3600e3 : duration==='7d' ? 7*24*3600e3 : 30*24*3600e3;
      membership = { until: Date.now() + ms };
      localStorage.setItem('membership', JSON.stringify(membership));
      paintVIP();
      alert('VIP activado üéâ');
    }
    function paintVIP(){ const on=isVIP(); vipBadge.style.display=on?'inline-block':'none'; vipEmojis.style.display=on?'flex':'none'; }

    /* ================= MISIONES DIARIAS ================= */
    const missionsModal = document.getElementById('missionsModal');
    const btnDaily = document.getElementById('btnDaily');
    btnDaily.onclick = ()=> openModal('missionsModal');
    document.getElementById('btnCloseMissions').onclick = ()=> closeModal('missionsModal');

    // Set urls
    document.getElementById('fb1').href=FB_URL_1;
    document.getElementById('fb2').href=FB_URL_2;
    document.getElementById('fb3').href=FB_URL_3;

    function todayKey(suffix){ return new Date().toISOString().slice(0,10)+'_'+suffix; }
    function setStatus(id,msg){ document.getElementById(id).textContent = msg; }

    document.getElementById('btnClaimFollow').onclick=()=>{
      const k = todayKey('follow');
      if(localStorage.getItem(k)) return setStatus('followStatus','Ya reclamado hoy ‚úÖ');
      localStorage.setItem(k,'1');
      updateCoins(20);
      setStatus('followStatus','¬°+20 moneditas acreditadas! üéâ');
    };
    document.getElementById('btnClaimReact').onclick=()=>{
      const k = todayKey('react');
      if(localStorage.getItem(k)) return setStatus('reactStatus','Ya reclamado hoy ‚úÖ');
      localStorage.setItem(k,'1');
      updateCoins(10);
      setStatus('reactStatus','¬°+10 moneditas acreditadas! ‚ù§Ô∏è');
    };

    /* ================= TIENDA / RECARGA ================= */
    document.getElementById('btnStore').onclick=()=> openModal('storeModal');
    document.getElementById('btnCloseStore').onclick=()=> closeModal('storeModal');

    document.getElementById('sBuy50').onclick = ()=>{ updateCoins(50); alert('Gracias por tu compra (50)'); };
    document.getElementById('sBuy150').onclick= ()=>{ updateCoins(150); alert('Gracias por tu compra (150)'); };
    document.getElementById('sBuy400').onclick= ()=>{ updateCoins(400); alert('Gracias por tu compra (400)'); };

    const rechargeModal=document.getElementById('rechargeModal');
    function openRecharge(){ rechargeModal.classList.add('show'); }
    document.getElementById('btnCloseModal').onclick=()=> rechargeModal.classList.remove('show');
    document.getElementById('btnBuy20').onclick=()=>{ updateCoins(20); rechargeModal.classList.remove('show'); };
    document.getElementById('btnBuy50').onclick=()=>{ updateCoins(50); rechargeModal.classList.remove('show'); };
    document.getElementById('btnBuy100').onclick=()=>{ updateCoins(100); rechargeModal.classList.remove('show'); };
    document.getElementById('btnWatchAd').onclick=()=>{ updateCoins(10); rechargeModal.classList.remove('show'); };

    /* ===== PayPal Buttons (VIP) ===== */
    function mountPayPal(containerId, amount, duration){
      const mount = ()=>{
        if(!window.paypal || !document.getElementById(containerId)) return setTimeout(mount,300);
        window.paypal.Buttons({
          style:{layout:'horizontal',height:40},
          createOrder: (data,actions)=> actions.order.create({purchase_units:[{amount:{value:String(amount)}}]}),
          onApprove: async (data,actions)=>{
            await actions.order.capture();
            setVIP(duration);
          },
          onError: ()=> alert('No se pudo procesar el pago. Intenta de nuevo.')
        }).render('#'+containerId);
      };
      mount();
    }
    // Tienda
    mountPayPal('paypal24h',4,'24h');
    mountPayPal('paypal7d',15,'7d');
    mountPayPal('paypal30d',30,'30d');
    // Modal recarga
    mountPayPal('paypal24h_m',4,'24h');
    mountPayPal('paypal7d_m',15,'7d');
    mountPayPal('paypal30d_m',30,'30d');

    /* ================= MODELOS DESDE FIRESTORE ================= */
    const chatList=document.getElementById('chatList');
    const slidesIntervals={};

    async function renderModels(){
      chatList.innerHTML='';
      const snap=await getDocs(collection(db,"models"));
      snap.forEach(docSnap=>{
        const m={id:docSnap.id, fb: (docSnap.data().fb||'#'), ...docSnap.data()};
        const card=document.createElement('div');
        card.className='model-card';

        const slideId='slide_'+m.id;
        const pub=(m.photos||[]).slice(0,3);
        const priv=(m.photos||[]).slice(3,5);

        card.innerHTML=`
          <div class="model-slideshow" id="${slideId}">
            ${pub.map((src,i)=>`<img src="${src}" class="${i===0?'active':''}" alt="${m.name}">`).join('')}
          </div>
          <div class="info">
            <div class="name">${m.name} <span class="online">‚óè Online</span></div>
            <div class="extra">${m.age||'‚Äî'} a√±os ¬∑ ${m.country||'‚Äî'}</div>
            <div class="desc">${m.desc||''}</div>
          </div>
          <div class="actions">
            <button class="action-btn btn-like">
              <img src="https://qu.ax/hlsxX.png" alt="like"><span>Me gusta</span>
              <span class="like-badge">${m.likes||0}</span>
            </button>
            <button class="action-btn btn-priv">
              <img src="${PRIVATE_ICON_URL}" alt="priv"><span>Ver privadas</span>
            </button>
            <button class="action-btn btn-fb">
              <img src="${FACEBOOK_ICON_URL}" alt="fb"><span>Facebook</span>
            </button>
            <button class="action-btn btn-msg">
              <img src="https://qu.ax/jGSiu.png" alt="mensaje"><span>Mensaje</span>
            </button>
          </div>
        `;

        // like visual
        card.querySelector('.btn-like').onclick=(e)=>{e.stopPropagation();const b=card.querySelector('.like-badge');b.textContent=String(parseInt(b.textContent||'0')+1);};

        // ver privadas
        card.querySelector('.btn-priv').onclick=(e)=>{
          e.stopPropagation();
          if(!isVIP()){ openModal('storeModal'); alert('Activa VIP para ver fotos privadas üíé'); return; }
          const w=window.open('','_blank','width=900,height=700');
          w.document.write('<title>Privadas</title>');
          (priv.length?priv:pub).forEach(src=> w.document.write(`<img src="${src}" style="max-width:100%;display:block;margin:8px 0;border-radius:8px">`) );
        };

        // facebook
        card.querySelector('.btn-fb').onclick=(e)=>{ e.stopPropagation(); if(m.fb && m.fb!=='#') window.open(m.fb,'_blank'); };

        // abrir chat (con interstitial previo)
        card.querySelector('.btn-msg').onclick=(e)=>{ e.stopPropagation(); showInterstitialSequence(()=>openChatWith(m)); };
        card.onclick=()=> showInterstitialSequence(()=>openChatWith(m));

        chatList.appendChild(card);
        startSlideshow(slideId);
      });
    }

    function startSlideshow(id){
      const box=document.getElementById(id); if(!box) return;
      const imgs=[...box.querySelectorAll('img')]; if(imgs.length<=1) return;
      let i=0;
      if(slidesIntervals[id]) clearInterval(slidesIntervals[id]);
      slidesIntervals[id]=setInterval(()=>{ imgs[i].classList.remove('active'); i=(i+1)%imgs.length; imgs[i].classList.add('active'); },2800);
    }

    /* ================= ROUTER ================= */
    const views={chat:'view-chat',conversation:'view-conversation'};
    function go(v){ Object.values(views).forEach(id=>document.getElementById(id).classList.remove('active')); document.getElementById(views[v]).classList.add('active'); }

    /* ================= CHAT ================= */
    let currentModel=null;
    const messages=document.getElementById('messages');
    const chatName=document.getElementById('chatName');
    const chatAvatar=document.getElementById('chatAvatar');
    const chatStatus=document.getElementById('chatStatus');
    const typingHint=document.getElementById('typingHint');

    document.querySelectorAll('#vipEmojis [data-emoji]').forEach(b=>{
      b.onclick=()=>{ const i=document.getElementById('msgText'); i.value+=b.dataset.emoji; i.focus(); };
    });

    function openChatWith(m){
      currentModel=m;
      chatName.textContent=m.name;
      chatAvatar.src=(m.photos&&m.photos[0])||'';
      chatStatus.textContent='En l√≠nea';
      messages.innerHTML=`<div class="msg them">Holi üíï soy ${m.name}, ¬øquieres jugar?</div>`;
      go('conversation');

      // Interstitial dentro del chat: nuevamente a los 0s y a los 3s
      showInterstitial(6);
      setTimeout(()=> showInterstitial(6), 3000);
    }

    document.getElementById('btnBack').onclick=()=>{ go('chat'); };

    document.getElementById('btnSend').onclick=sendMsg;
    document.getElementById('msgText').addEventListener('keydown',e=>{ if(e.key==='Enter'){e.preventDefault();sendMsg();} });

    function sendMsg(){
      if(!currentModel) return;
      const input=document.getElementById('msgText');
      const val=(input.value||'').trim(); if(!val) return;

      if(!isVIP()){
        if((session.coins||0) < COIN_PER_MSG){ openRecharge(); return; }
        updateCoins(-COIN_PER_MSG);
      }

      const ts=Date.now();
      messages.innerHTML+=`<div class="msg you">${sanitize(val)}<div class="meta">${new Date(ts).toLocaleTimeString()} ¬∑ enviado</div></div>`;
      input.value='';

      typing(true);
      setTimeout(()=>{
        const metas=[...messages.querySelectorAll('.msg.you .meta')];
        if(metas.length){ metas[metas.length-1].textContent=`${new Date(ts).toLocaleTimeString()} ¬∑ visto`; }
        setTimeout(()=>{ typing(false); autoReply(val); },3000);
      },500);

      clearTimeout(window.__idleTimer);
      window.__idleTimer=setTimeout(()=> chatStatus.textContent='Desconectado', 90000);
    }

    function typing(on){ typingHint.classList.toggle('on',!!on); chatStatus.textContent=on?'En l√≠nea ¬∑ escribiendo‚Ä¶':'En l√≠nea'; }

    /* ===== Auto-respuestas simples por keywords ===== */
    const BOT = [
      {k:['hola','buenas','hey','holi'], r:['Hola üòò ¬øC√≥mo te llamas?','Holi üíï ¬øc√≥mo est√°s?','Hola bb üòè']},
      {k:['foto','privada','contenido'], r:['Activa VIP para ver mis privadas üíé','Tengo sorpresas en privadas‚Ä¶ üòâ Activa VIP']},
      {k:['precio','cuanto','costo','valor','vip'], r:['VIP 24h $4 ¬∑ 1 semana $15 ¬∑ 1 mes $30. ¬øCu√°l quieres?','Podemos hablar sin l√≠mites si activas VIP üíé']},
      {k:['donde','pais','de donde'], r:['Soy latina y cari√±osa üòò','M√°s cerquita de lo que crees üòâ']},
      {k:['whatsapp','numero','tel'], r:['Qued√©monos aqu√≠ por seguridad üíï','Aqu√≠ estamos m√°s c√≥modos üòå']}
    ];
    const FALLBACKS=['Estoy aqu√≠ para ti üíñ','Mmm‚Ä¶ cu√©ntame m√°s üòè','¬øQu√© te gustar√≠a hacer ahora? üòâ','Me encantas üòò'];

    function autoReply(userText=''){
      const t=userText.toLowerCase();
      let pool=null;
      for(const m of BOT){ if(m.k.some(w=>t.includes(w))){ pool = m.r; break; } }
      const reply = (pool||FALLBACKS)[Math.floor(Math.random()*(pool||FALLBACKS).length)];
      messages.innerHTML+=`<div class="msg them">${sanitize(reply)}<div class="meta">${new Date().toLocaleTimeString()}</div></div>`;
    }

    /* ================= INTERSTITIAL CONTROL ================= */
    const interstitial=document.getElementById('interstitialOverlay');
    const closeInterstitial=document.getElementById('closeInterstitial');
    const interCounter=document.getElementById('interCounter');
    let interTimer=null;

    function showInterstitial(seconds=6){
      interstitial.classList.add('show');
      closeInterstitial.style.display='none';
      let sec=seconds;
      interCounter.textContent=`Cierra disponible en ${sec}s`;
      clearInterval(interTimer);
      interTimer=setInterval(()=>{
        sec--;
        if(sec>0){ interCounter.textContent=`Cierra disponible en ${sec}s`; }
        else{ clearInterval(interTimer); interCounter.textContent=''; closeInterstitial.style.display='inline-block'; }
      },1000);
    }

    function showInterstitialSequence(cb){
      // 1) Mostrar previa
      showInterstitial(6);
      // cerrar => ejecuta callback (abrir chat)
      const handler=()=>{ interstitial.classList.remove('show'); closeInterstitial.removeEventListener('click',handler); if(typeof cb==='function') cb(); };
      closeInterstitial.addEventListener('click',handler);
    }

    closeInterstitial.onclick=()=> interstitial.classList.remove('show');

    // Mostrar 2 veces al inicio (al cargar y a los 3s)
    window.addEventListener('load',()=>{ showInterstitial(6); setTimeout(()=>showInterstitial(6),3000); });

    /* ================= UTIL ================= */
    function openModal(id){ document.getElementById(id).classList.add('show'); }
    function closeModal(id){ document.getElementById(id).classList.remove('show'); }
    function sanitize(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

    // cerrar modales clic fuera
    ['storeModal','rechargeModal','missionsModal'].forEach(id=>{
      document.getElementById(id).addEventListener('click',e=>{ if(e.target.id===id) e.target.classList.remove('show'); });
    });

    /* INIT */
    document.getElementById('coinsLabel2').textContent=session.coins||0;
    renderModels();
  </script>
</body>
</html>
