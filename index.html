<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rifas | Emprendimiento</title>
  <!-- Fuente con look "chubby" -->
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff; /* fondo blanco solicitado */
      --fg:#0f172a; /* texto principal */
      --muted:#64748b; /* texto secundario */
      --primary:#0ea5e9; /* acento profesional */
      --primary-600:#0284c7;
      --ring:#bae6fd;
      --ok:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;
      --card:#f8fafc;
      --border:#e2e8f0;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family:"Fredoka", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    .container{max-width:1200px; margin:0 auto; padding:24px;}

    header{
      display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap; margin-bottom:16px;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .brand h1{font-weight:700; letter-spacing:.5px; margin:0;}
    .brand .badge{font-size:12px; color:var(--primary-600); background:var(--ring); padding:4px 8px; border-radius:999px;}

    .tabs{display:flex; gap:6px; background:var(--card); padding:6px; border-radius:12px; border:1px solid var(--border)}
    .tab{border:none; background:transparent; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; color:var(--muted)}
    .tab.active{background:#fff; color:var(--fg); box-shadow:0 1px 0 0 rgba(15,23,42,.06);}

    .grid{display:grid; grid-template-columns:2fr 1fr; gap:20px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}

    .card{background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:0 6px 18px rgba(2,8,23,.04);}
    .card h3{margin:0 0 8px 0}
    .card .hd{padding:16px 18px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:12px}
    .card .bd{padding:16px 18px}

    /* Tickets */
    .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .search{position:relative; flex:1; min-width:240px;}
    .search input{width:100%; padding:10px 38px 10px 40px; border-radius:12px; border:1px solid var(--border); outline:none; font-weight:500}
    .search svg{position:absolute; left:12px; top:50%; transform:translateY(-50%);}
    .toolbar .btn{padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:600}
    .toolbar .btn.primary{background:var(--primary); color:#fff; border-color:var(--primary)}

    .tickets-grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(70px,1fr)); gap:8px;}
    .ticket{padding:10px 0; text-align:center; border:1px dashed var(--border); border-radius:12px; background:var(--card); cursor:pointer; font-weight:600}
    .ticket:hover{border-color:var(--primary); box-shadow:0 0 0 3px var(--ring)}
    .ticket[disabled]{opacity:.35; cursor:not-allowed; text-decoration:line-through}

    .pagination{display:flex; gap:6px; flex-wrap:wrap; align-items:center; justify-content:center; margin-top:14px}
    .page-btn{border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600}
    .page-btn.active{background:var(--primary); border-color:var(--primary); color:#fff}

    .summary{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; background:var(--card); padding:12px; border-radius:12px; border:1px solid var(--border)}

    .pill{display:inline-flex; align-items:center; gap:8px; background:#fff; border:1px solid var(--border); padding:8px 12px; border-radius:999px}

    .progress{height:12px; background:var(--card); border-radius:999px; overflow:hidden; border:1px solid var(--border)}
    .bar{height:100%; background:linear-gradient(90deg,var(--primary), #22d3ee); width:0%}

    .selected-wrap{display:flex; gap:8px; flex-wrap:wrap}
    .chip{background:#fff; border:1px solid var(--border); padding:6px 8px; border-radius:999px; display:inline-flex; align-items:center; gap:6px; font-weight:600}
    .chip button{border:none; background:transparent; cursor:pointer; font-weight:700; color:var(--danger)}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:680px){.row{grid-template-columns:1fr}}

    label{display:block; font-weight:600; margin-bottom:6px}
    input[type="text"], input[type="number"], input[type="file"], select{width:100%; padding:12px 12px; border:1px solid var(--border); border-radius:12px; outline:none; font-weight:500}

    .radios{display:grid; grid-template-columns:1fr; gap:10px}
    .pay-option{display:flex; align-items:center; gap:12px; padding:10px; border:1px solid var(--border); border-radius:12px;}
    .pay-option img{width:26px; height:26px; object-fit:contain}

    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .btn{border:none; padding:12px 16px; border-radius:12px; font-weight:700; cursor:pointer}
    .btn.primary{background:var(--primary); color:#fff}
    .btn.secondary{background:#fff; border:1px solid var(--border)}
    .btn.danger{background:var(--danger); color:#fff}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    .alert{display:none; margin-top:10px; background:#fff; border-left:6px solid var(--warn); padding:12px; border:1px solid var(--border); border-radius:10px}
    .alert.show{display:block}

    /* Verificador */
    .verify-tabs{display:flex; gap:8px; margin-bottom:10px}
    .verify-tabs button{border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:10px; font-weight:600; cursor:pointer}
    .verify-tabs .active{background:var(--primary); color:#fff; border-color:var(--primary)}

    .result{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px}
    .result h4{margin:4px 0 10px}
    .muted{color:var(--muted)}

    .footnote{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <svg width="34" height="34" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 7.5C3 6.11929 4.11929 5 5.5 5H18.5C19.8807 5 21 6.11929 21 7.5V16.5C21 17.8807 19.8807 19 18.5 19H5.5C4.11929 19 3 17.8807 3 16.5V7.5Z" stroke="currentColor" stroke-width="1.5"/>
          <path d="M8.5 5V3.5M15.5 5V3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M3 9H21" stroke="currentColor" stroke-width="1.5"/>
        </svg>
        <h1>Rifas Pro</h1>
        <span class="badge">0000 ‚Äì 9999</span>
      </div>
      <div class="tabs" role="tablist">
        <button id="tab-comprar" class="tab active" role="tab" aria-selected="true">Comprar</button>
        <button id="tab-verificar" class="tab" role="tab" aria-selected="false">Verificador</button>
      </div>
    </header>

    <!-- Secci√≥n COMPRAR -->
    <section id="section-comprar" aria-labelledby="tab-comprar">
      <div class="grid">
        <!-- Columna izquierda: Tickets -->
        <div class="card">
          <div class="hd">
            <div style="display:flex; flex-direction:column; gap:4px">
              <h3>Lista de boletos</h3>
              <span class="muted">Selecciona tus n√∫meros o usa el generador de suerte.</span>
            </div>
            <div class="pill"><strong id="contador-boletos">0</strong> seleccionados</div>
          </div>
          <div class="bd">
            <div class="toolbar">
              <div class="search">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M21 21L16.65 16.65" stroke="#64748b" stroke-width="1.5" stroke-linecap="round"/>
                  <circle cx="11" cy="11" r="7.25" stroke="#64748b" stroke-width="1.5"/>
                </svg>
                <input id="input-search" type="text" placeholder="Buscar boleto (0000-9999)" maxlength="4" inputmode="numeric" autocomplete="off"/>
              </div>
              <button class="btn" id="btn-limpiar">Limpiar selecci√≥n</button>
              <button class="btn primary" id="btn-aleatorio">üé≤ Generar 3 al azar</button>
            </div>

            <div class="summary" style="margin:12px 0">
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
                <span class="muted">Avance de ventas</span>
                <div class="progress" style="width:220px"><div id="bar" class="bar"></div></div>
                <span id="pct" class="pill">0% vendido</span>
              </div>
              <div class="pill">Total: <span id="total-bs" style="font-weight:700;">Bs 0</span></div>
            </div>

            <div id="tickets" class="tickets-grid" aria-live="polite"></div>

            <div class="pagination" id="pagination"></div>

            <div style="margin-top:12px">
              <div class="selected-wrap" id="selected-chips"></div>
            </div>

            <div id="alert-min" class="alert">‚ö†Ô∏è Compra m√≠nima: 3 boletos.</div>
          </div>
        </div>

        <!-- Columna derecha: Formulario y pago -->
        <div class="card">
          <div class="hd">
            <h3>Datos personales y pago</h3>
          </div>
          <div class="bd">
            <form id="form-compra">
              <div class="row">
                <div>
                  <label for="nombre">Nombre y apellido</label>
                  <input id="nombre" type="text" placeholder="Ej: Ana P√©rez" required />
                </div>
                <div>
                  <label for="cedula">C√©dula</label>
                  <input id="cedula" type="text" inputmode="numeric" placeholder="Ej: 12345678" required />
                </div>
              </div>

              <div class="row">
                <div>
                  <label for="pais">Pa√≠s (c√≥digo y bandera)</label>
                  <select id="pais" required>
                    <!-- Puedes editar/a√±adir pa√≠ses aqu√≠ -->
                    <option value="VE" data-code="+58">üáªüá™ Venezuela (+58)</option>
                    <option value="CO" data-code="+57">üá®üá¥ Colombia (+57)</option>
                    <option value="US" data-code="+1">üá∫üá∏ Estados Unidos (+1)</option>
                    <option value="ES" data-code="+34">üá™üá∏ Espa√±a (+34)</option>
                  </select>
                </div>
                <div>
                  <label for="telefono">Tel√©fono</label>
                  <input id="telefono" type="text" inputmode="numeric" placeholder="Ej: 04121234567" required />
                  <div class="footnote" id="e164">Formato: +58 0412******</div>
                </div>
              </div>

              <div class="row">
                <div>
                  <label for="ref6">√öltimos 6 d√≠gitos de la referencia</label>
                  <input id="ref6" type="text" inputmode="numeric" maxlength="6" placeholder="Ej: 123456" required />
                </div>
                <div>
                  <label for="comprobante">Subir comprobante de pago</label>
                  <input id="comprobante" type="file" accept="image/*,application/pdf" />
                </div>
              </div>

              <div style="margin:10px 0 4px"><strong>M√©todos de pago</strong> <span class="muted">(elige uno)</span></div>
              <div class="radios" id="metodos-pago"></div>
              <div class="footnote">Puedes editar los datos y logos en el objeto <code>PAYMENTS_CONFIG</code> dentro del script.</div>

              <div style="margin-top:14px" class="actions">
                <button type="button" class="btn secondary" id="btn-borrador">Guardar borrador</button>
                <button type="submit" class="btn primary" id="btn-confirmar" disabled>Confirmar compra</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- Secci√≥n VERIFICADOR -->
    <section id="section-verificar" aria-labelledby="tab-verificar" hidden>
      <div class="card">
        <div class="hd">
          <h3>Verificador de boletos</h3>
        </div>
        <div class="bd">
          <div class="verify-tabs">
            <button class="active" id="vtab-tlf">Por tel√©fono</button>
            <button id="vtab-boleto">Por # boleto</button>
          </div>

          <div id="vf-telefono">
            <div class="row">
              <div>
                <label for="v-pais">Pa√≠s</label>
                <select id="v-pais">
                  <option value="VE" data-code="+58">üáªüá™ Venezuela (+58)</option>
                  <option value="CO" data-code="+57">üá®üá¥ Colombia (+57)</option>
                  <option value="US" data-code="+1">üá∫üá∏ Estados Unidos (+1)</option>
                  <option value="ES" data-code="+34">üá™üá∏ Espa√±a (+34)</option>
                </select>
              </div>
              <div>
                <label for="v-telefono">Tel√©fono</label>
                <input id="v-telefono" type="text" inputmode="numeric" placeholder="Ej: 04121234567" />
              </div>
            </div>
            <div style="margin-top:10px" class="actions">
              <button class="btn primary" id="btn-buscar-tlf">Buscar</button>
            </div>
          </div>

          <div id="vf-boleto" hidden>
            <label for="v-boleto"># Boleto (0000‚Äì9999)</label>
            <input id="v-boleto" type="text" maxlength="4" inputmode="numeric" placeholder="Ej: 0042" />
            <div style="margin-top:10px" class="actions">
              <button class="btn primary" id="btn-buscar-boleto">Buscar</button>
            </div>
          </div>

          <div id="resultados" style="margin-top:16px"></div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ==========================
    // CONFIGURACI√ìN EDITABLE
    // ==========================
    const PRECIO_BOLETO_BS = 15; // Precio por boleto

    // Edita los datos/indicaciones y logos (URL) aqu√≠
    const PAYMENTS_CONFIG = [
      {
        id: 'bdv_transfer',
        nombre: 'Transferencia BDV',
        logoUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b3/Banco_de_Venezuela_logo.svg/512px-Banco_de_Venezuela_logo.svg.png', // Cambia por tu URL
        detalle: `Banco de Venezuela\nTitular: TU NOMBRE O RAZ√ìN SOCIAL\nRIF/C√©dula: V-00000000\nCuenta: 0102-0000-00-0000000000\nCorreo: tuemail@dominio.com`,
      },
      {
        id: 'bdv_pm',
        nombre: 'Pago m√≥vil BDV (Banco de Venezuela)',
        logoUrl: 'https://seeklogo.com/images/B/banco-de-venezuela-logo-0D0E7A6B01-seeklogo.com.png', // Cambia por tu URL
        detalle: `Pago m√≥vil BDV\nBanco: Banco de Venezuela\nTel√©fono: 0412-0000000\nC√©dula/RIF: V-00000000\nNombre: TU NOMBRE`,
      },
      {
        id: 'binance',
        nombre: 'Binance',
        logoUrl: 'https://cryptologos.cc/logos/binance-coin-bnb-logo.png', // Cambia por tu URL
        detalle: `Binance P2P\nUsuario: TuUsuario\nRed/Moneda: USDT (TRC20/BEP20)\nNota: Indica tu nombre y # de boletos en el memo.`,
      },
    ];

    // ==========================
    // ESTADO DE LA APLICACI√ìN
    // ==========================
    const TOTAL_TICKETS = 10000; // 0000 - 9999
    const PAGES = 5;             // 5 p√°ginas solicitadas
    const PAGE_SIZE = TOTAL_TICKETS / PAGES; // 2000 por p√°gina

    let selected = new Set();       // selecci√≥n actual (en proceso de compra)
    let sold = new Set();           // vendidos hist√≥ricos (persistidos)
    let currentPage = 0;            // 0..4

    // ==========================
    // UTILIDADES
    // ==========================
    const pad4 = n => n.toString().padStart(4, '0');
    const currency = n => `Bs ${n.toLocaleString('es-VE')}`;

    function loadState(){
      const raw = localStorage.getItem('purchases');
      if(!raw) return;
      try{
        const all = JSON.parse(raw) || [];
        for(const p of all){ for(const t of (p.tickets||[])) sold.add(t); }
      }catch(e){ console.warn('No se pudo cargar estado', e); }
    }

    function savePurchase(purchase){
      const raw = localStorage.getItem('purchases');
      const arr = raw ? JSON.parse(raw) : [];
      arr.push(purchase);
      localStorage.setItem('purchases', JSON.stringify(arr));
    }

    function purchasesByPhone(fullPhone){
      const raw = localStorage.getItem('purchases');
      const arr = raw ? JSON.parse(raw) : [];
      return arr.filter(p=>p.fullPhone === fullPhone);
    }

    function purchaseByTicket(ticket){
      const raw = localStorage.getItem('purchases');
      const arr = raw ? JSON.parse(raw) : [];
      return arr.find(p=> (p.tickets||[]).includes(ticket));
    }

    function updateProgress(){
      const pct = Math.round((sold.size / TOTAL_TICKETS) * 100);
      document.getElementById('bar').style.width = pct + '%';
      document.getElementById('pct').textContent = pct + '% vendido';
    }

    function updateSummary(){
      document.getElementById('contador-boletos').textContent = selected.size;
      document.getElementById('total-bs').textContent = currency(selected.size * PRECIO_BOLETO_BS);
      document.getElementById('btn-confirmar').disabled = selected.size < 3 || !document.querySelector('input[name="paymethod"]:checked');
    }

    // ==========================
    // RENDER DE TICKETS
    // ==========================
    function renderPagination(){
      const pag = document.getElementById('pagination');
      pag.innerHTML = '';
      for(let i=0;i<PAGES;i++){
        const start = i*PAGE_SIZE; const end = start + PAGE_SIZE - 1;
        const b = document.createElement('button');
        b.className = 'page-btn' + (i===currentPage?' active':'');
        b.textContent = `${pad4(start)}‚Äì${pad4(end)}`;
        b.addEventListener('click', ()=>{ currentPage = i; renderTickets(); });
        pag.appendChild(b);
      }
    }

    function renderTickets(){
      const grid = document.getElementById('tickets');
      grid.innerHTML = '';
      const start = currentPage * PAGE_SIZE; const end = start + PAGE_SIZE;
      for(let n=start; n<end; n++){
        const id = pad4(n);
        if(sold.has(id) || selected.has(id)) continue; // ocultar los ya vendidos/seleccionados
        const btn = document.createElement('button');
        btn.className = 'ticket';
        btn.textContent = id;
        btn.addEventListener('click', ()=>{
          selected.add(id);
          renderTickets(); // lo elimina de la lista
          renderSelectedChips();
          updateSummary();
          document.getElementById('alert-min').classList.remove('show');
        });
        grid.appendChild(btn);
      }
    }

    function renderSelectedChips(){
      const wrap = document.getElementById('selected-chips');
      wrap.innerHTML = '';
      [...selected].sort().forEach(id=>{
        const ch = document.createElement('span');
        ch.className='chip';
        ch.innerHTML = `#${id} <button title="Quitar">√ó</button>`;
        ch.querySelector('button').addEventListener('click', ()=>{
          selected.delete(id);
          renderTickets();
          renderSelectedChips();
          updateSummary();
        });
        wrap.appendChild(ch);
      });
    }

    // ==========================
    // B√öSQUEDA / LUPA
    // ==========================
    function handleSearch(){
      const v = (document.getElementById('input-search').value || '').replace(/\D/g,'');
      if(!v) return;
      const id = pad4(Number(v));
      // hallar p√°gina
      const num = Number(id);
      const page = Math.floor(num / PAGE_SIZE);
      currentPage = page;
      renderPagination();
      renderTickets();
      // Intentar resaltar si est√° disponible
      if(!(sold.has(id) || selected.has(id))){
        // Parpadeo simple del bot√≥n
        const btn = [...document.querySelectorAll('.ticket')].find(b => b.textContent === id);
        if(btn){
          btn.style.boxShadow = '0 0 0 4px ' + getComputedStyle(document.documentElement).getPropertyValue('--ring');
          btn.scrollIntoView({behavior:'smooth', block:'center'});
          setTimeout(()=>btn.style.boxShadow='', 1200);
        }
      } else {
        // Mostrar alerta si no est√° disponible
        const alert = document.getElementById('alert-min');
        alert.textContent = `‚ö†Ô∏è El boleto #${id} ya no est√° disponible.`;
        alert.classList.add('show');
        setTimeout(()=>{
          alert.classList.remove('show');
          alert.textContent = '‚ö†Ô∏è Compra m√≠nima: 3 boletos.';
        }, 1800);
      }
    }

    // ==========================
    // GENERADOR ALEATORIO (3)
    // ==========================
    function randomThree(){
      const need = Math.max(0, 3 - selected.size);
      if(need === 0){
        toast('Ya tienes 3 o m√°s seleccionados.');
        return;
      }
      // Construye lista de disponibles globales (cuidado con performance: 10k ok)
      const available = [];
      for(let n=0;n<TOTAL_TICKETS;n++){
        const id = pad4(n);
        if(!sold.has(id) && !selected.has(id)) available.push(id);
      }
      shuffleInPlace(available);
      for(let i=0;i<Math.min(need, available.length); i++){
        selected.add(available[i]);
      }
      renderTickets(); renderSelectedChips(); updateSummary();
    }

    function shuffleInPlace(arr){
      for(let i=arr.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    // ==========================
    // M√âTODOS DE PAGO (render)
    // ==========================
    function renderPayments(){
      const wrap = document.getElementById('metodos-pago');
      wrap.innerHTML = '';
      PAYMENTS_CONFIG.forEach((p,i)=>{
        const row = document.createElement('label');
        row.className = 'pay-option';
        row.innerHTML = `
          <input type="radio" name="paymethod" value="${p.id}" ${i===0?'checked':''} />
          <img src="${p.logoUrl}" alt="${p.nombre}" onerror="this.style.display='none'" />
          <div>
            <div style="font-weight:700">${p.nombre}</div>
            <pre style="margin:6px 0 0; font-family:inherit; white-space:pre-wrap; color:var(--muted)">${p.detalle}</pre>
          </div>
        `;
        wrap.appendChild(row);
      });
      // Clic inicial para validar bot√≥n Confirmar
      document.querySelectorAll('input[name="paymethod"]').forEach(r=>{
        r.addEventListener('change', updateSummary)
      });
    }

    // ==========================
    // VALIDACIONES Y SUBMIT
    // ==========================
    function toast(msg){
      const a = document.getElementById('alert-min');
      a.textContent = msg; a.classList.add('show');
      setTimeout(()=>{ a.classList.remove('show'); a.textContent = '‚ö†Ô∏è Compra m√≠nima: 3 boletos.'; }, 2000);
    }

    function validate(){
      const name = document.getElementById('nombre').value.trim();
      const cedula = document.getElementById('cedula').value.trim();
      const pais = document.getElementById('pais');
      const code = pais.options[pais.selectedIndex].dataset.code;
      const telefono = document.getElementById('telefono').value.trim();
      const ref6 = document.getElementById('ref6').value.trim();
      const pm = document.querySelector('input[name="paymethod"]:checked');

      if(selected.size < 3){ toast('‚ö†Ô∏è Compra m√≠nima: 3 boletos.'); return null; }
      if(!name || !cedula || !telefono || !ref6 || !pm){ toast('Completa todos los campos requeridos.'); return null; }
      if(!/^\d{6}$/.test(ref6)){ toast('La referencia debe tener 6 d√≠gitos.'); return null; }
      if(!/^\d{5,}$/.test(telefono)){ toast('Tel√©fono inv√°lido.'); return null; }

      return { name, cedula, country: pais.value, code, telefono, ref6, payId: pm.value };
    }

    async function fileToDataURL(file){
      if(!file) return null;
      return new Promise(res=>{
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.readAsDataURL(file);
      });
    }

    async function onSubmit(e){
      e.preventDefault();
      const v = validate();
      if(!v) return;

      // Preparar compra
      const tickets = [...selected].sort();
      const amount = tickets.length * PRECIO_BOLETO_BS;
      const method = PAYMENTS_CONFIG.find(p=>p.id===v.payId);

      const file = document.getElementById('comprobante').files[0];
      const fileDataURL = await fileToDataURL(file); // se almacena localmente para demo

      const purchase = {
        name: v.name,
        cedula: v.cedula,
        country: v.country,
        code: v.code,
        phone: v.telefono,
        fullPhone: `${v.code} ${v.telefono}`,
        refLast6: v.ref6,
        paymentMethod: method?.nombre || v.payId,
        tickets,
        amountBs: amount,
        receipt: fileDataURL ? { name: file?.name, dataUrl: fileDataURL } : null,
        dateISO: new Date().toISOString(),
      };

      // Persistir y bloquear n√∫meros
      savePurchase(purchase);
      tickets.forEach(t=>sold.add(t));
      selected.clear();

      // UI updates
      renderSelectedChips();
      renderTickets();
      updateSummary();
      updateProgress();

      // Confirmaci√≥n
      alert(`¬°Compra confirmada!\nBoletos: ${purchase.tickets.join(', ')}\nTotal: ${currency(purchase.amountBs)}\nTitular: ${purchase.name}`);
    }

    // ==========================
    // VERIFICADOR
    // ==========================
    function switchVerifyTab(which){
      document.getElementById('vtab-tlf').classList.toggle('active', which==='tlf');
      document.getElementById('vtab-boleto').classList.toggle('active', which==='boleto');
      document.getElementById('vf-telefono').hidden = !(which==='tlf');
      document.getElementById('vf-boleto').hidden = !(which==='boleto');
      document.getElementById('resultados').innerHTML = '';
    }

    function renderResultsForPhone(fullPhone){
      const out = document.getElementById('resultados');
      const records = purchasesByPhone(fullPhone);
      if(records.length===0){ out.innerHTML = `<div class="result">No se encontraron compras para <strong>${fullPhone}</strong>.</div>`; return; }
      const blocks = records.map(p=>{
        return `
          <div class="result">
            <h4>Cliente: ${p.name} ‚Äî C.I.: ${p.cedula}</h4>
            <div class="muted">Tel: ${p.fullPhone} ¬∑ Ref: ${p.refLast6} ¬∑ M√©todo: ${p.paymentMethod} ¬∑ Fecha: ${new Date(p.dateISO).toLocaleString()}</div>
            <div style="margin-top:8px">Boletos: <strong>${p.tickets.join(', ')}</strong></div>
            <div>Total: <strong>${currency(p.amountBs)}</strong></div>
          </div>
        `;
      }).join('\n');
      out.innerHTML = blocks;
    }

    function renderResultsForTicket(tic
