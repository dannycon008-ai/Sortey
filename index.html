<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Galer√≠a / Cat√°logo</title>
  <style>
    :root{
      --bg:#0b0d12;
      --panel:#121522;
      --panel2:#151a2b;
      --text:#e9eefc;
      --muted:#9aa6c6;
      --accent:#7c5cff;
      --accent2:#4bd3ff;
      --border:rgba(255,255,255,.08);
      --shadow: 0 12px 35px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 500px at 20% -10%, rgba(124,92,255,.20), transparent 60%),
        radial-gradient(1000px 420px at 90% 10%, rgba(75,211,255,.12), transparent 55%),
        linear-gradient(180deg, #080a10, var(--bg));
      color:var(--text);
      min-height:100vh;
    }

    .wrap{max-width:1180px;margin:0 auto;padding:22px 16px 90px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      margin:8px 0 18px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:700;letter-spacing:.2px;
    }
    .logo{
      width:36px;height:36px;border-radius:12px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 20px rgba(124,92,255,.25);
    }
    .brand small{display:block;color:var(--muted);font-weight:500;margin-top:2px}

    .toolbar{
      display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }

    .search{
      display:flex;gap:10px;align-items:center;flex:1;min-width:280px;
      background: rgba(0,0,0,.28);
      border:1px solid var(--border);
      border-radius: 14px;
      padding:10px 12px;
    }
    .search input{
      width:100%;
      background:transparent;border:0;outline:none;
      color:var(--text);
      font-size:14px;
    }
    .btn{
      border:0;cursor:pointer;
      color:#fff;
      background: linear-gradient(135deg, var(--accent), #5b44ff);
      padding:10px 14px;border-radius: 12px;
      font-weight:650;
      box-shadow: 0 10px 18px rgba(124,92,255,.25);
      transition: transform .08s ease, filter .2s ease;
      white-space:nowrap;
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      box-shadow:none;
      color:var(--text);
    }

    .chips{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius: 14px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      transition: background .2s ease, border-color .2s ease;
      font-weight:600;
      font-size:13px;
    }
    .chip.active{
      background: rgba(124,92,255,.18);
      border-color: rgba(124,92,255,.45);
    }
    .chip .dot{
      width:8px;height:8px;border-radius:99px;background:rgba(255,255,255,.35)
    }
    .chip.active .dot{background: var(--accent)}

    .sort{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .sort label{color:var(--muted);font-size:13px}
    select{
      background: rgba(0,0,0,.28);
      border:1px solid var(--border);
      color:var(--text);
      border-radius: 12px;
      padding:10px 12px;
      outline:none;
      cursor:pointer;
      font-weight:600;
    }

    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:14px;
    }
    @media (max-width: 1050px){ .grid{grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 780px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 480px){ .grid{grid-template-columns: 1fr;} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      display:flex;flex-direction:column;
      min-height: 320px;
    }
    .thumb{
      position:relative;
      width:100%;
      aspect-ratio: 16 / 10;
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    .thumb img{
      width:100%;height:100%;
      object-fit:cover;
      display:block;
      transform: scale(1.02);
      filter: saturate(1.05) contrast(1.05);
    }
    .badge{
      position:absolute;left:12px;top:12px;
      background: rgba(20,24,40,.85);
      border:1px solid rgba(255,255,255,.14);
      color:#dfffe9;
      font-weight:800;
      font-size:12px;
      padding:6px 10px;border-radius: 999px;
      letter-spacing:.3px;
      text-transform: uppercase;
    }
    .badge.new{ color:#dfffe9; }
    .badge.hot{ color:#ffe9c2; }
    .watermark{
      position:absolute;right:10px;top:10px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 8px;border-radius:12px;
      font-size:11px;color:rgba(255,255,255,.85);
      backdrop-filter: blur(6px);
    }

    .content{padding:14px 14px 12px;display:flex;flex-direction:column;gap:10px;flex:1}
    .title{
      font-weight:800;
      letter-spacing:.2px;
      margin:0;
      font-size:16px;
    }
    .meta{
      display:flex;gap:14px;flex-wrap:wrap;
      color:var(--muted);
      font-size:12.5px;
      align-items:center;
    }
    .meta span{display:inline-flex;gap:6px;align-items:center}

    .actions{
      display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:auto;
    }

    .share{
      display:flex;gap:8px;align-items:center;
    }
    .iconBtn{
      width:38px;height:38px;border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      display:grid;place-items:center;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease;
    }
    .iconBtn:hover{background: rgba(255,255,255,.07)}
    .iconBtn:active{transform: translateY(1px)}
    .iconBtn svg{width:18px;height:18px;fill: rgba(255,255,255,.88)}

    .empty{
      margin:22px 0;
      padding:22px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius: var(--radius);
      color: var(--muted);
      text-align:center;
    }

    /* Modal */
    .modal{
      position:fixed;inset:0;
      background: rgba(0,0,0,.6);
      display:none;
      align-items:center;justify-content:center;
      padding:18px;
      z-index: 1000;
    }
    .modal.show{display:flex}
    .modalCard{
      width:min(980px, 100%);
      background: rgba(16,18,28,.92);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      gap:10px;
    }
    .modalHead strong{font-size:14px}
    .close{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      border-radius: 12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:700;
    }
    .player{
      width:100%;
      aspect-ratio: 16/9;
      background:#000;
      position:relative;
    }
    .player iframe, .player video{
      width:100%;height:100%;
      display:block;border:0;
      background:#000;
    }

    /* Botones flotantes derecha */
    .floatSocial{
      position: fixed;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 1200;
    }
    .fab{
      width: 54px;
      height: 54px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      display: grid;
      place-items: center;
      box-shadow: 0 14px 26px rgba(0,0,0,.35);
      cursor: pointer;
      transition: transform .08s ease, filter .2s ease;
      backdrop-filter: blur(8px);
    }
    .fab:active{ transform: translateY(1px); }
    .fab svg{ width: 22px; height: 22px; fill: rgba(255,255,255,.95); }

    .fab-share{ background: rgba(124,92,255,.85); }
    .fab-telegram{ background: rgba(0,136,204,.85); }
    .fab-whatsapp{ background: rgba(37,211,102,.85); }
    .fab-facebook{ background: rgba(24,119,242,.85); }

    @media (max-width: 520px){
      .fab{ width: 48px; height: 48px; }
      .fab svg{ width: 20px; height: 20px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          Cat√°logo
          <small>Im√°genes y videos por URL externa</small>
        </div>
      </div>
      <button class="btn secondary" id="btnReset">Restablecer</button>
    </div>

    <div class="toolbar">
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="rgba(255,255,255,.75)" stroke-width="2"/>
          <path d="M16.2 16.2 21 21" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <input id="q" type="search" placeholder="Buscar modelo o video..." autocomplete="off" />
        <button class="btn" id="btnSearch">Buscar</button>
      </div>

      <div class="chips" role="tablist" aria-label="Filtros">
        <div class="chip active" data-filter="all" role="tab" aria-selected="true">
          <span class="dot"></span> Todos
        </div>
        <div class="chip" data-filter="new" role="tab" aria-selected="false">
          <span class="dot"></span> Nuevos
        </div>
        <div class="chip" data-filter="popular" role="tab" aria-selected="false">
          <span class="dot"></span> Populares
        </div>
      </div>

      <div class="sort">
        <label for="sort">Ordenar por:</label>
        <select id="sort">
          <option value="recent">M√°s recientes</option>
          <option value="views">M√°s vistas</option>
          <option value="name">Nombre (A‚ÄìZ)</option>
        </select>
      </div>
    </div>

    <div id="grid" class="grid" aria-live="polite"></div>
    <div id="empty" class="empty" style="display:none;">No hay resultados con esos filtros.</div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="Reproductor">
    <div class="modalCard">
      <div class="modalHead">
        <strong id="modalTitle">Video</strong>
        <button class="close" id="modalClose">Cerrar ‚úï</button>
      </div>

      <div class="player" id="player">
        <div id="posterLayer" style="position:absolute; inset:0; display:grid; place-items:center;">
          <img id="posterImg" alt="Poster" style="width:100%;height:100%;object-fit:cover;display:block;filter:saturate(1.05) contrast(1.05);" />
          <button id="playBtn" class="btn"
            style="position:absolute; display:flex; align-items:center; gap:10px; padding:12px 16px; border-radius:14px;">
            ‚ñ∂ Reproducir
          </button>
        </div>
        <div id="mediaLayer" style="position:absolute; inset:0;"></div>
      </div>
    </div>
  </div>

  <!-- Botones flotantes derecha -->
  <div class="floatSocial" aria-label="Accesos r√°pidos">
    <button class="fab fab-share" id="fabShare" title="Compartir">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a2.5 2.5 0 0 0 0-1.39l7-4.11A2.99 2.99 0 1 0 14 5a2.9 2.9 0 0 0 .05.54l-7 4.11a3 3 0 1 0 0 4.7l7.12 4.19c-.03.17-.05.34-.05.51a3 3 0 1 0 3-3Z"/>
      </svg>
    </button>

    <button class="fab fab-telegram" id="fabTelegram" title="Telegram">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M21.8 3.3 2.9 10.6c-1.3.5-1.3 1.2-.2 1.5l4.9 1.5 11.3-7.1c.5-.3 1-.1.6.2l-9.2 8.4-.3 4.5c.4 0 .6-.2.9-.5l2.2-2.1 4.6 3.4c.9.5 1.5.2 1.7-.8l3-14.1c.3-1.2-.4-1.7-1.5-1.3Z"/>
      </svg>
    </button>

    <button class="fab fab-whatsapp" id="fabWhatsApp" title="WhatsApp">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M20.5 3.5A11 11 0 0 0 2.9 16.8L2 22l5.4-1.4A11 11 0 0 0 20.5 3.5Zm-8.5 18a9 9 0 0 1-4.6-1.2l-.3-.2-3.2.8.9-3.1-.2-.3A9 9 0 1 1 12 21.5Zm5.2-6.8c-.3-.1-1.7-.8-2-.9-.3-.1-.5-.1-.7.1-.2.3-.8.9-1 .9-.2.1-.4.1-.7-.1-.3-.1-1.3-.5-2.5-1.6-.9-.8-1.6-1.9-1.8-2.2-.2-.3 0-.5.1-.6l.5-.6c.2-.2.2-.4.3-.6.1-.2 0-.4 0-.6 0-.1-.7-1.7-.9-2.3-.2-.6-.5-.5-.7-.5h-.6c-.2 0-.6.1-.9.4-.3.3-1.2 1.1-1.2 2.7s1.2 3.1 1.4 3.3c.2.2 2.4 3.7 5.9 5.2.8.3 1.4.5 1.9.6.8.2 1.5.2 2.1.1.6-.1 1.7-.7 1.9-1.4.2-.7.2-1.3.1-1.4 0-.1-.3-.2-.6-.3Z"/>
      </svg>
    </button>

    <button class="fab fab-facebook" id="fabFacebook" title="Facebook">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M22 12a10 10 0 1 0-11.6 9.9v-7H8.1V12h2.3V9.8c0-2.3 1.4-3.6 3.5-3.6 1 0 2 .2 2 .2v2.2h-1.1c-1.1 0-1.4.7-1.4 1.4V12h2.5l-.4 2.9h-2.1v7A10 10 0 0 0 22 12Z"/>
      </svg>
    </button>
  </div>

<script>
(() => {
  /***********************
   * CONFIG WORDPRESS
   ***********************/
  const WP = {
    base: "https://uncorazon.store",
    type: "posts",
    perPage: 50
  };

  let items = [];

  let state = { query:"", filter:"all", sort:"recent" };

  const $ = (sel) => document.querySelector(sel);
  const grid = $("#grid");
  const empty = $("#empty");

  // --- Utilidades
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(str){ return escapeHtml(str); }

  function stripHtml(html){
    const div = document.createElement("div");
    div.innerHTML = html || "";
    return (div.textContent || div.innerText || "").trim();
  }

  function fmtDate(iso){
    if(!iso) return "‚Äî";
    const [y,m,d] = iso.split("-").map(Number);
    if(!y || !m || !d) return iso;
    return `${String(d).padStart(2,"0")}/${String(m).padStart(2,"0")}/${y}`;
  }

  function isRecent(dateStr){
    const d = new Date(dateStr);
    if(isNaN(d)) return false;
    return (Date.now() - d.getTime()) <= 7*24*60*60*1000;
  }

  function normalizeUrl(url){
    if(!url) return "";
    url = String(url).trim().replace(/^["']|["']$/g, "");
    url = url.replaceAll("\\/", "/");
    if(/^https?:[^/]/i.test(url)){
      url = url.replace(/^https?:/i, (m)=> m + "//");
    }
    return url;
  }

  // Detecta mp4 + iframes + youtube links
  function extractVideoUrl(html){
    if(!html) return "";

    // <video src="...">
    let m = html.match(/<video[^>]+src=["']([^"']+)["']/i);
    if(m?.[1]) return m[1];

    // <source src="...">
    m = html.match(/<source[^>]+src=["']([^"']+)["']/i);
    if(m?.[1]) return m[1];

    // iframe src (youtube/vimeo/etc.)
    m = html.match(/<iframe[^>]+src=["']([^"']+)["']/i);
    if(m?.[1]) return m[1];

    // link a mp4 en <a href="">
    m = html.match(/<a[^>]+href=["']([^"']+\.(mp4|webm|ogg)(\?[^"']*)?)["']/i);
    if(m?.[1]) return m[1];

    // URL suelta mp4
    m = html.match(/https?:\/\/[^\s"'<>]+\.(mp4|webm|ogg)(\?[^\s"'<>]*)?/i);
    if(m?.[0]) return m[0];

    // youtube watch / youtu.be -> embed
    m = html.match(/https?:\/\/(www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]{6,})/i);
    if(m?.[2]) return `https://www.youtube.com/embed/${m[2]}`;

    m = html.match(/https?:\/\/youtu\.be\/([a-zA-Z0-9_-]{6,})/i);
    if(m?.[1]) return `https://www.youtube.com/embed/${m[1]}`;

    return "";
  }

  function extractFirstImageUrl(html){
    const m = (html || "").match(/<img[^>]+src=["']([^"']+)["']/i);
    return m?.[1] || "";
  }

  function badgeFor(item){
    const popularThreshold = 500;
    if(item.isNew) return { text:"Nuevo", cls:"new" };
    if((item.views || 0) >= popularThreshold) return { text:"Popular", cls:"hot" };
    return null;
  }

  /***********************
   * TOAST
   ***********************/
  let toastTimer;
  function toast(msg){
    let el = document.getElementById("toast");
    if(!el){
      el = document.createElement("div");
      el.id = "toast";
      el.style.position = "fixed";
      el.style.left = "50%";
      el.style.bottom = "18px";
      el.style.transform = "translateX(-50%)";
      el.style.padding = "12px 14px";
      el.style.borderRadius = "14px";
      el.style.background = "rgba(15,18,28,.92)";
      el.style.border = "1px solid rgba(255,255,255,.14)";
      el.style.color = "rgba(255,255,255,.92)";
      el.style.boxShadow = "0 16px 40px rgba(0,0,0,.45)";
      el.style.zIndex = "2000";
      document.body.appendChild(el);
    }
    el.textContent = msg;
    el.style.display = "block";
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{ el.style.display="none"; }, 1800);
  }

  /***********************
   * CARGA DESDE WORDPRESS
   ***********************/
  async function fetchWPPosts(){
    const url = `${WP.base}/wp-json/wp/v2/${WP.type}?per_page=${WP.perPage}&_embed`;
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`WP API error: ${res.status}`);

    const posts = await res.json();

    items = posts.map(p => {
      const titleRaw = p.title?.rendered || "";
      const titleClean = stripHtml(titleRaw);
      const title = titleClean ? titleClean : `Post #${p.id}`;

      const link = p.link || "#";
      const dateISO = (p.date || "").slice(0,10);

      const html = p.content?.rendered || "";

      // featured image
      const featured = p._embedded?.["wp:featuredmedia"]?.[0];
      let thumbUrl =
        featured?.media_details?.sizes?.large?.source_url ||
        featured?.media_details?.sizes?.medium_large?.source_url ||
        featured?.source_url ||
        "";

      // fallback: primera imagen del contenido
      if(!thumbUrl){
        thumbUrl = extractFirstImageUrl(html);
      }

      if(!thumbUrl){
        thumbUrl = "https://via.placeholder.com/1200x750?text=Sin+Imagen";
      }

      const videoUrl = normalizeUrl(extractVideoUrl(html));

      return {
        id: String(p.id),
        name: title,
        thumbUrl,
        videoUrl,     // puede ser mp4 o iframe/embed
        link,
        views: 0,
        date: dateISO || "2026-01-01",
        isNew: isRecent(p.date_gmt || p.date)
      };
    });

    applyState();
  }

  /***********************
   * FILTROS / ORDEN / RENDER
   ***********************/
  function applyState(){
    const q = state.query.trim().toLowerCase();
    let list = items.slice();

    if(q){
      list = list.filter(x =>
        (x.name || "").toLowerCase().includes(q) ||
        (x.id || "").toLowerCase().includes(q)
      );
    }

    if(state.filter === "new"){
      list = list.filter(x => x.isNew);
    } else if(state.filter === "popular"){
      list = list.slice().sort((a,b)=> (b.views||0) - (a.views||0)).slice(0, 50);
    }

    if(state.sort === "recent"){
      list.sort((a,b)=> (b.date || "").localeCompare(a.date || ""));
    } else if(state.sort === "views"){
      list.sort((a,b)=> (b.views||0) - (a.views||0));
    } else if(state.sort === "name"){
      list.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    }

    render(list);
  }

  function render(list){
    grid.innerHTML = "";
    empty.style.display = list.length ? "none" : "block";

    const frag = document.createDocumentFragment();

    for(const item of list){
      const card = document.createElement("div");
      card.className = "card";

      const b = badgeFor(item);
      const hasVideo = !!item.videoUrl;

      card.innerHTML = `
        <div class="thumb">
          <img loading="lazy" src="${escapeAttr(item.thumbUrl)}" alt="${escapeAttr(item.name)}">
          ${b ? `<div class="badge ${b.cls}">${b.text}</div>` : ""}
          <div class="watermark">Cat√°logo</div>
        </div>

        <div class="content">
          <h3 class="title">${escapeHtml(item.name)}</h3>

          <div class="meta">
            <span title="Vistas">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12Z" stroke="rgba(255,255,255,.65)" stroke-width="2"/>
                <circle cx="12" cy="12" r="3" stroke="rgba(255,255,255,.65)" stroke-width="2"/>
              </svg>
              ${Number(item.views||0).toLocaleString("es-ES")} vistas
            </span>

            <span title="Fecha">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M7 3v2M17 3v2" stroke="rgba(255,255,255,.65)" stroke-width="2" stroke-linecap="round"/>
                <path d="M4 7h16" stroke="rgba(255,255,255,.65)" stroke-width="2"/>
                <path d="M6 5h12a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2Z" stroke="rgba(255,255,255,.65)" stroke-width="2"/>
              </svg>
              ${fmtDate(item.date)}
            </span>
          </div>

          <div class="actions">
            ${
              hasVideo
                ? `<button class="btn secondary" data-action="watch" data-id="${escapeAttr(item.id)}">Ver video</button>`
                : `<button class="btn secondary" data-action="open" data-id="${escapeAttr(item.id)}">Abrir entrada</button>`
            }

            <div class="share">
              <button class="iconBtn" title="Compartir" data-action="share" data-id="${escapeAttr(item.id)}">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a2.5 2.5 0 0 0 0-1.39l7-4.11A2.99 2.99 0 1 0 14 5a2.9 2.9 0 0 0 .05.54l-7 4.11a3 3 0 1 0 0 4.7l7.12 4.19c-.03.17-.05.34-.05.51a3 3 0 1 0 3-3Z"/></svg>
              </button>
              <button class="iconBtn" title="Copiar enlace" data-action="copy" data-id="${escapeAttr(item.id)}">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M10 14a5 5 0 0 1 0-7l1-1a5 5 0 0 1 7 7l-1 1" />
                  <path d="M14 10a5 5 0 0 1 0 7l-1 1a5 5 0 0 1-7-7l1-1" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      `;

      // stroke icon link
      card.querySelectorAll('svg path').forEach(p=>{
        if(!p.getAttribute("stroke") && p.getAttribute("d")?.includes("M10 14")) {
          p.setAttribute("fill","none");
          p.setAttribute("stroke","rgba(255,255,255,.88)");
          p.setAttribute("stroke-width","2");
          p.setAttribute("stroke-linecap","round");
          p.setAttribute("stroke-linejoin","round");
        }
      });

      frag.appendChild(card);
    }

    grid.appendChild(frag);
  }

 /***********************
 * MODAL (FIXED / ESTABLE)
 ***********************/
const modal = $("#modal");
const modalTitle = $("#modalTitle");
const posterImg = $("#posterImg");
const posterLayer = $("#posterLayer");
const mediaLayer = $("#mediaLayer");
const playBtn = $("#playBtn");
let currentItem = null;

let activeNode = null;     // <video> o <iframe>
let lastFocus = null;

function isVideoFile(url){
  return /\.(mp4|webm|ogg)(\?.*)?$/i.test(url || "");
}

function detectYouTubeId(url){
  try{
    const u = new URL(url, location.href);
    // youtu.be/ID
    if(u.hostname.includes("youtu.be")){
      const id = u.pathname.replace("/", "").trim();
      return id || "";
    }
    // youtube.com/watch?v=ID
    if(u.hostname.includes("youtube.com")){
      const v = u.searchParams.get("v");
      if(v) return v.trim();
      // /embed/ID
      const parts = u.pathname.split("/").filter(Boolean);
      const i = parts.indexOf("embed");
      if(i >= 0 && parts[i+1]) return parts[i+1].trim();
      // /shorts/ID
      const j = parts.indexOf("shorts");
      if(j >= 0 && parts[j+1]) return parts[j+1].trim();
    }
  }catch{}
  return "";
}

function normalizeYouTubeUrl(url){
  const id = detectYouTubeId(url);
  if(!id) return "";
  return `https://www.youtube.com/embed/${id}`;
}

function teardownMedia(){
  if(!activeNode){
    mediaLayer.innerHTML = "";
    return;
  }

  // Detener video de forma fuerte (corta red + libera buffer)
  if(activeNode.tagName === "VIDEO"){
    try{
      activeNode.pause();
      activeNode.removeAttribute("src");
      activeNode.load();
    }catch{}
  }

  try{ activeNode.remove(); }catch{}
  activeNode = null;
  mediaLayer.innerHTML = "";
}

function showPoster(){
  posterLayer.style.display = "grid";
}
function hidePoster(){
  posterLayer.style.display = "none";
}

/**
 * Crea y monta el reproductor.
 * - MP4: usa preload=metadata, muted=true para permitir autoplay estable.
 * - YouTube: embebe con autoplay=1&mute=1 (mute ayuda a autoplay).
 */
async function buildMedia(url){
  url = normalizeUrl(url);

  // Limpieza previa SIEMPRE
  teardownMedia();
  showPoster();

  if(!url){
    toast("Video URL vac√≠a ‚ùå");
    return;
  }

  // Si es un enlace de YouTube en formato watch/youtu.be, lo normalizamos
  const ytEmbed = normalizeYouTubeUrl(url);
  const looksLikeYouTube = !!ytEmbed || /youtube\.com|youtu\.be/i.test(url);

  // --- MP4 / WEBM / OGG ---
  if(isVideoFile(url) && !looksLikeYouTube){
    const v = document.createElement("video");

    // Atributos ‚Äúestables‚Äù
    v.controls = true;
    v.playsInline = true;
    v.preload = "metadata";   // mejor para CDN
    v.muted = true;           // clave para autoplay estable
    v.autoplay = false;       // controlado por JS

    // Si quieres poster real (adem√°s de tu capa), podr√≠as:
    // v.poster = currentItem?.thumbUrl || "";

    // Logs de depuraci√≥n √∫tiles
    v.addEventListener("error", () => {
      console.error("‚ùå VIDEO ERROR:", v.error, "URL:", url);
      toast("No se pudo reproducir el MP4 (CORS / CDN / formato) ‚ùå");
      teardownMedia();
      showPoster();
    });

    // Cuando ya hay data m√≠nima, ocultamos poster
    // (loadeddata suele ser m√°s consistente que canplay)
    v.addEventListener("loadeddata", () => hidePoster());

    // Montar
    v.src = url;
    mediaLayer.appendChild(v);
    activeNode = v;

    // Intento de reproducci√≥n controlado (autoplay)
    try{
      v.load();
      const p = v.play();
      if(p && typeof p.then === "function") await p;
      // Si play() funciona, quitamos poster
      hidePoster();
    }catch(err){
      // Autoplay bloqueado: dejamos controles y el usuario le da play
      console.info("Autoplay bloqueado o fall√≥:", err);
      // Dejamos el poster visible hasta interacci√≥n del usuario
      // pero si prefieres mostrar el video con controles aunque no reproduzca:
      hidePoster();
      // y si quieres permitir sonido al tocar play manual:
      v.muted = false;
    }

    return;
  }

  // --- IFRAME (YouTube u otros embeds) ---
  const iframe = document.createElement("iframe");

  // Si es YouTube, forzamos embed limpio y autoplay con mute
  let src = url;
  if(looksLikeYouTube){
    src = ytEmbed || url;
    const join = src.includes("?") ? "&" : "?";
    src = src + join + "autoplay=1&mute=1&rel=0&modestbranding=1";
    iframe.allow =
      "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
  }else{
    const join = src.includes("?") ? "&" : "?";
    src = src + join + "autoplay=1";
    iframe.allow = "autoplay; encrypted-media; picture-in-picture";
  }

  iframe.src = src;
  iframe.allowFullscreen = true;
  iframe.style.width = "100%";
  iframe.style.height = "100%";
  iframe.style.border = "0";

  mediaLayer.appendChild(iframe);
  activeNode = iframe;

  // iframe: ocultamos poster de una vez
  hidePoster();
}

function openPosterModal(item){
  currentItem = item;
  modalTitle.textContent = item.name || "Video";
  posterImg.src = item.thumbUrl;

  teardownMedia();
  showPoster();

  lastFocus = document.activeElement;

  modal.classList.add("show");
  document.body.style.overflow = "hidden";

  console.log("üé¨ OPEN MODAL:", { id: item.id, videoUrl: item.videoUrl, link: item.link });
}

function closeModal(){
  modal.classList.remove("show");
  document.body.style.overflow = "";

  teardownMedia();
  showPoster();

  currentItem = null;

  // devuelve foco
  try{ lastFocus?.focus?.(); }catch{}
}

$("#modalClose").addEventListener("click", closeModal);
modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });
document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && modal.classList.contains("show")) closeModal(); });

// Bot√≥n ‚ÄúReproducir‚Äù (interacci√≥n del usuario => autoplay ya no molesta)
playBtn.addEventListener("click", async () => {
  if(!currentItem) return;

  if(!currentItem.videoUrl){
    toast("Esta entrada no tiene video detectado ‚ùå");
    return;
  }

  console.log("‚ñ∂ PLAY:", currentItem.videoUrl);
  await buildMedia(currentItem.videoUrl);

  currentItem.views = (currentItem.views || 0) + 1;
  applyState();
});

  /***********************
   * EVENTOS UI
   ***********************/
  $("#btnSearch").addEventListener("click", ()=>{
    state.query = $("#q").value;
    applyState();
  });

  $("#q").addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      state.query = $("#q").value;
      applyState();
    }
  });

  $("#sort").addEventListener("change", (e)=>{
    state.sort = e.target.value;
    applyState();
  });

  document.querySelectorAll(".chip").forEach(chip=>{
    chip.addEventListener("click", ()=>{
      document.querySelectorAll(".chip").forEach(c=>c.classList.remove("active"));
      chip.classList.add("active");
      state.filter = chip.dataset.filter;
      applyState();
    });
  });

  $("#btnReset").addEventListener("click", ()=>{
    state = { query:"", filter:"all", sort:"recent" };
    $("#q").value = "";
    $("#sort").value = "recent";
    document.querySelectorAll(".chip").forEach(c=>c.classList.remove("active"));
    document.querySelector('.chip[data-filter="all"]').classList.add("active");
    applyState();
  });

  // Clicks en cards
  grid.addEventListener("click", async (e)=>{
    const btn = e.target.closest("[data-action]");
    if(!btn) return;

    const action = btn.dataset.action;
    const id = btn.dataset.id;

    const item = items.find(x => x.id === id);
    if(!item) return;

    if(action === "watch"){
      openPosterModal(item);
    }

    if(action === "open"){
      window.open(item.link, "_blank", "noopener,noreferrer");
    }

    if(action === "copy"){
      const link = makeItemLink(item);
      await navigator.clipboard.writeText(link);
      toast("Enlace copiado ‚úÖ");
    }

    if(action === "share"){
      const data = { title: item.name, text: `Mira: ${item.name}`, url: makeItemLink(item) };
      if(navigator.share){
        try { await navigator.share(data); } catch {}
      } else {
        await navigator.clipboard.writeText(data.url);
        toast("No hay compartir nativo. Enlace copiado ‚úÖ");
      }
    }
  });

  function makeItemLink(item){
    const base = location.href.split("#")[0];
    return `${base}#${encodeURIComponent(item.id)}`;
  }

  function handleHash(){
    const id = decodeURIComponent((location.hash||"").replace("#",""));
    if(!id) return;
    const item = items.find(x => x.id === id);
    if(!item) return;
    if(item.videoUrl){
      openPosterModal(item);
    } else {
      window.open(item.link, "_blank", "noopener,noreferrer");
    }
  }
  window.addEventListener("hashchange", handleHash);

  /***********************
   * BOTONES FLOTANTES
   ***********************/
  const fabShare = $("#fabShare");
  const fabTelegram = $("#fabTelegram");
  const fabWhatsApp = $("#fabWhatsApp");
  const fabFacebook = $("#fabFacebook");

  if(fabShare){
    fabShare.addEventListener("click", async ()=>{
      const url = location.href;
      if(navigator.share){
        try { await navigator.share({ title: document.title, url }); } catch {}
      } else {
        await navigator.clipboard.writeText(url);
        toast("Enlace copiado ‚úÖ");
      }
    });
  }

  if(fabTelegram){
    fabTelegram.addEventListener("click", ()=>{
      // Cambia TU usuario o link de canal
      const tg = "https://t.me/";
      window.open(tg, "_blank", "noopener,noreferrer");
    });
  }

  if(fabWhatsApp){
    fabWhatsApp.addEventListener("click", ()=>{
      // Cambia TU n√∫mero con prefijo (ej: 584125160806)
      const phone = "584125160806";
      const msg = encodeURIComponent("Hola, quiero informaci√≥n ‚úÖ");
      window.open(`https://wa.me/${phone}?text=${msg}`, "_blank", "noopener,noreferrer");
    });
  }

  if(fabFacebook){
    fabFacebook.addEventListener("click", ()=>{
      // Cambia TU p√°gina
      const fb = "https://facebook.com/";
      window.open(fb, "_blank", "noopener,noreferrer");
    });
  }

  /***********************
   * INIT
   ***********************/
  (async function init(){
    try{
      toast("Conectando WordPress‚Ä¶");
      await fetchWPPosts();
      toast("Sincronizado ‚úÖ");
      handleHash();
    } catch (err){
      console.error(err);
      toast("Error conectando WordPress ‚ùå");
      empty.style.display = "block";
      empty.textContent = "No se pudo sincronizar con WordPress. Revisa consola / CORS / URL.";
    }
  })();
})();
</script>

</body>
</html>
