<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TuChat ‚Äî Demo</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ====== ESTILOS MODELOS (RESPETA TU LOOK) ====== */
    .model-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:18px;
      margin-top:18px;
    }
    .model-card {
      background:#fff;color:#000;border-radius:14px;overflow:hidden;
      box-shadow:0 4px 20px rgba(0,0,0,.12);
      display:flex;flex-direction:column;cursor:pointer;
      transition:transform .25s ease, box-shadow .25s ease;
      animation:softFloat 4s ease-in-out infinite;
    }
    .model-card:hover{transform:translateY(-4px) scale(1.02);box-shadow:0 12px 30px rgba(0,0,0,.2)}
    @keyframes softFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .model-slideshow{position:relative;height:200px}
    .model-slideshow img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .6s ease}
    .model-slideshow img.active{opacity:1}
    .model-card .info{padding:12px;display:flex;flex-direction:column;gap:6px}
    .model-card .name{font-weight:700;font-size:16px;color:#111}
    .model-card .extra{font-size:12px;color:#555}
    .model-card .desc{font-size:13px;color:#333}
    .model-card .online{display:inline-block;background:#27ae60;color:#fff;font-size:12px;padding:2px 6px;border-radius:6px;margin-left:6px}
    .model-card .actions{display:flex;gap:10px;justify-content:space-between;align-items:center;padding:10px 12px;background:#f7f9fb;border-top:1px solid #eaeef3}
    .action-btn{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid #e0e6ee;background:#fff;cursor:pointer;transition:.2s;font-weight:600;font-size:13px;color:#222}
    .action-btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.08)}
    .action-btn img{width:18px;height:18px;display:block}
    .like-badge{background:#ff2e6a;color:#fff;font-size:12px;padding:2px 8px;border-radius:999px}

    /* ====== GENERALES ====== */
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:Poppins,system-ui,sans-serif;background:#0b1220;color:#e9f6ff}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .header{position:sticky;top:0;z-index:50;background:rgba(10,18,32,.85);backdrop-filter:blur(6px);border-bottom:1px solid #132338}
    .header-inner{display:flex;justify-content:space-between;align-items:center;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .dot{width:10px;height:10px;border-radius:50%;background:#ff2e6a;display:inline-block}
    .btn{border:0;padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer;transition:.15s;font-size:14px}
    .btn-primary{background:#ff2e6a;color:#fff}
    .btn-ghost{background:transparent;color:#cfe7ff;border:1px solid #244362}
    .btn-warning{background:#ffb020;color:#1b1407}
    .input{width:100%;background:#0e192a;color:#d9eeff;border:1px solid #1f3550;border-radius:12px;padding:10px 12px}
    .card{background:#0f1a2b;border:1px solid #1b3150;border-radius:18px;padding:16px;box-shadow:0 10px 32px rgba(0,0,0,.35)}
    .small{color:#9bc2df;font-size:12px}
    .view{display:none}.view.active{display:block}

    /* ====== BANNER VIDEO ====== */
    .banner-wrap{position:relative;margin-top:8px}
    .banner-wrap video{width:100%;max-height:180px;object-fit:cover;border-radius:14px;display:block}
    .live-badge{position:absolute;top:12px;left:12px;background:#001f99;color:#fff;font-weight:700;font-size:14px;padding:6px 12px;border-radius:10px;animation:pulse 1.5s infinite;box-shadow:0 0 8px rgba(0,0,0,.4)}
    @keyframes pulse{0%{transform:scale(1);opacity:1}50%{transform:scale(1.1);opacity:.85}100%{transform:scale(1);opacity:1}}

    /* ====== CHAT ====== */
    .chat-card{height:calc(100vh - 80px);display:flex;flex-direction:column}
    .chat-head{display:flex;align-items:center;gap:10px;border-bottom:1px solid #1b3150;padding:10px;background:#0f1a2b}
    .chat-head .name{font-weight:700}
    .chat-body{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;padding:10px 2px}
    .msg{max-width:70%;padding:10px 14px;border-radius:18px;line-height:1.35;font-size:15px;animation:floatIn .25s ease}
    .msg.you{align-self:flex-end;background:#12253c}
    .msg.them{align-self:flex-start;background:#0c1728}
    .msg .meta{margin-top:6px;font-size:11px;color:#86a9c7}
    .typing{color:#99c7ff;font-size:12px;padding:6px 0;display:none}
    .typing.on{display:block}
    .chat-input{display:flex;gap:8px;align-items:center;padding:10px;border-top:1px solid #1b3150;background:#0f1a2b}
    .chat-input .input{flex:1}
    .emoji-vip{display:flex;gap:6px;flex-wrap:wrap}
    @keyframes floatIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    /* ====== MODALES ====== */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;z-index:1000}
    .modal.show{display:grid}
    .modal .content{background:#0f1a2b;border:1px solid #1b3150;border-radius:18px;padding:16px;width:min(520px,92vw);box-shadow:0 24px 60px rgba(0,0,0,.45)}

    /* ====== ZONAS PUBLICIDAD ====== */
    .ads-row{display:grid;grid-template-columns:1fr 280px;gap:16px;margin-top:16px}
    @media (max-width:1000px){.ads-row{grid-template-columns:1fr}}
    .ad-box{background:#0f1a2b;border:1px dashed #27415f;border-radius:12px;padding:12px;text-align:center;color:#9bc2df}
    .ad-sticky-bottom{position:sticky;bottom:0;margin-top:14px}

    /* Interstitial InPage */
    .interstitial{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;place-items:center;z-index:1500}
    .interstitial.show{display:grid}
    .interstitial .inner{background:#0f1a2b;padding:0;border-radius:16px;overflow:hidden;border:1px solid #1b3150;width:min(640px,94vw)}
    .interstitial iframe,.interstitial img{display:block;width:100%;height:360px;object-fit:cover}
    .interstitial .bar{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-top:1px solid #1b3150}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="header-inner container">
      <div class="brand">
        <img id="appLogo" src="https://qu.ax/PyOjt.png" alt="Logo" style="height:36px;border-radius:8px;object-fit:contain">
        <span>ChispaLive</span>
      </div>
      <nav style="display:flex;gap:10px;align-items:center">
        <span id="vipBadge" class="small" style="display:none;background:#ffd54d;color:#1e1600;padding:4px 8px;border-radius:999px;font-weight:700">VIP ‚ú®</span>
        <button class="btn btn-ghost" id="btnDaily">üéÅ Bono diario</button>
        <button class="btn btn-ghost" id="btnReferral">üéØ Referidos</button>
        <button class="btn btn-primary" id="btnStore">üí≥ Tienda</button>
        <div style="margin-left:6px">Monedas: <b id="coinsLabel">0</b></div>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- BANNER VIDEO -->
    <div class="banner-wrap">
      <a id="bannerLink" href="https://ejemplo.com" target="_blank" rel="noopener">
        <video autoplay muted loop playsinline>
          <source src="https://qu.ax/dMvpz.mp4" type="video/mp4">
          Tu navegador no soporta video.
        </video>
        <div class="live-badge">üî¥ En directo</div>
      </a>
    </div>

    <!-- FILA CON MODELOS + LATERAL ADS -->
    <div class="ads-row">
      <section id="view-chat" class="view active">
        <h3>Modelos</h3>
        <div class="model-grid" id="chatList"></div>

        <!-- Banner CPA inferior -->
        <div class="ad-sticky-bottom ad-box" id="cpaBottom">
          <!-- Pega aqu√≠ tu banner CPA (HTML/script de tu red) -->
          Banner CPA inferior (coloca aqu√≠ tu c√≥digo)
        </div>
      </section>

      <!-- Lateral derecho: banners -->
      <aside>
        <div class="ad-box" id="adRight1" style="min-height:250px">Banner lateral 300x250</div>
        <div class="ad-box" id="adRight2" style="min-height:600px;margin-top:16px">Skyscraper 300x600</div>
      </aside>
    </div>

    <!-- CHAT -->
    <section id="view-conversation" class="view">
      <div class="card chat-card">
        <div class="chat-head">
          <button class="btn btn-ghost" id="btnBack">‚Üê Volver</button>
          <img id="chatAvatar" src="" style="width:40px;height:40px;border-radius:50%;object-fit:cover">
          <div>
            <div id="chatName" class="name"></div>
            <small id="chatStatus" class="small">En l√≠nea</small>
          </div>
          <div style="margin-left:auto" class="small">Monedas: <b id="coinsLabel2">0</b></div>
        </div>
        <div class="chat-body" id="messages"></div>
        <div class="typing" id="typingHint">Est√° escribiendo‚Ä¶</div>
        <div class="chat-input">
          <input class="input" id="msgText" placeholder="Escribe un mensaje (2 monedas / ilimitado si VIP)"/>
          <div class="emoji-vip" id="vipEmojis" title="Emojis VIP (requiere VIP)" style="display:none">
            <button class="btn btn-ghost" data-emoji="üíã">üíã</button>
            <button class="btn btn-ghost" data-emoji="üî•">üî•</button>
            <button class="btn btn-ghost" data-emoji="üíé">üíé</button>
          </div>
          <button class="btn btn-primary" id="btnSend">Enviar</button>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL: RECARGA / OFERTA VIP -->
  <div id="rechargeModal" class="modal">
    <div class="content">
      <h3 style="margin:0 0 6px">Sin monedas üò¢</h3>
      <p class="small">Cada mensaje cuesta <b>2</b> moneditas.</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <button class="btn btn-primary" id="btnBuy20">Comprar 20</button>
        <button class="btn btn-primary" id="btnBuy50">Comprar 50</button>
        <button class="btn btn-primary" id="btnBuy100">Comprar 100</button>
        <button class="btn btn-warning" id="btnWatchAd">Ver anuncio (+10)</button>
      </div>
      <div class="card" style="margin-top:8px">
        <b>üíé Suscr√≠bete VIP y chatea sin l√≠mites</b>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button class="btn btn-ghost" data-vip="24h">VIP 24h</button>
          <button class="btn btn-ghost" data-vip="7d">VIP 1 semana</button>
          <button class="btn btn-ghost" data-vip="30d">VIP 1 mes</button>
        </div>
      </div>
      <div style="margin-top:10px">
        <button class="btn btn-ghost" id="btnCloseModal">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: TIENDA DIRECTA -->
  <div id="storeModal" class="modal">
    <div class="content">
      <h3 style="margin:0 0 6px">Tienda</h3>
      <p class="small">Compra monedas o activa VIP.</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <button class="btn btn-primary" id="sBuy50">50 monedas</button>
        <button class="btn btn-primary" id="sBuy150">150 monedas</button>
        <button class="btn btn-primary" id="sBuy400">400 monedas</button>
      </div>
      <div class="card" style="margin-top:8px">
        <b>üíé VIP</b>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button class="btn btn-ghost" data-vip2="24h">VIP 24h</button>
          <button class="btn btn-ghost" data-vip2="7d">VIP 1 semana</button>
          <button class="btn btn-ghost" data-vip2="30d">VIP 1 mes</button>
        </div>
      </div>
      <div style="margin-top:10px">
        <button class="btn btn-ghost" id="btnCloseStore">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: REFERIDOS -->
  <div id="refModal" class="modal">
    <div class="content">
      <h3 style="margin:0 0 6px">Referidos</h3>
      <p class="small">Comparte tu c√≥digo. Cuando alguien lo use, ambos ganan monedas.</p>
      <div class="card" style="display:flex;gap:8px;align-items:center">
        <div class="small">Tu c√≥digo:</div>
        <code id="myRefCode" style="font-weight:700"></code>
        <button class="btn btn-ghost" id="btnCopyRef">Copiar</button>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="small">Redimir c√≥digo:</div>
        <input class="input" id="refInput" placeholder="Pega un c√≥digo">
        <button class="btn btn-primary" id="btnRedeemRef">Redimir</button>
      </div>
      <div style="margin-top:10px">
        <button class="btn btn-ghost" id="btnCloseRef">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- INTERSTITIAL INPAGE (al entrar/salir del chat) -->
  <div id="inpage" class="interstitial">
    <div class="inner">
      <!-- Reemplaza por el tag de tu red publicitaria (iframe/script) -->
      <a id="inpageLink" href="https://example-ads.com" target="_blank" rel="noopener">
        <img src="https://picsum.photos/800/360" alt="Publicidad">
      </a>
      <div class="bar">
        <span class="small" style="opacity:.85;margin-left:8px">Publicidad ‚Äî Interstitial</span>
        <button class="btn btn-ghost" id="closeInpage">Cerrar</button>
      </div>
    </div>
  </div>

  <script type="module">
    /* ================= FIREBASE ================= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAlWJTeezvz0Xkd363SgN5CnHFbEp8uNQU",
      authDomain: "chispalive-b7ed6.firebaseapp.com",
      projectId: "chispalive-b7ed6",
      storageBucket: "chispalive-b7ed6.appspot.com",
      messagingSenderId: "334811479289",
      appId: "1:334811479289:web:403a2a1b10f7af6704b628",
      measurementId: "G-60ERX1MFT7"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ================= CONFIG R√ÅPIDA (URLs Anuncios) ================= */
    const AD_POP_URL = "https://TU_LINK_POP_ANUNCIO.com";       // Pop-under al 1er click
    const INPAGE_URL = "https://TU_LINK_INTERSTITIAL.com";      // Interstitial InPage
    document.getElementById('inpageLink').href = INPAGE_URL;

    /* ================= SESI√ìN / ECONOM√çA ================= */
    const START_COINS = 50;
    const COIN_PER_MSG = 2;
    const DAILY_BONUS = 10;
    const REF_BONUS_OWNER = 15;
    const REF_BONUS_GUEST = 20;

    const coinsLabel = document.getElementById('coinsLabel');
    const coinsLabel2 = document.getElementById('coinsLabel2');
    const vipBadge = document.getElementById('vipBadge');
    const vipEmojis = document.getElementById('vipEmojis');

    let session = JSON.parse(localStorage.getItem('session')||'{}');
    if(!session.alias){ session = { alias:'Usuario', coins: START_COINS, refCode: genRef() }; saveSession(); }
    updateCoins(0); // pintar

    // Membres√≠a VIP en localStorage: { until: timestamp }
    let membership = JSON.parse(localStorage.getItem('membership')||'null');
    paintVIP();

    function saveSession(){ localStorage.setItem('session', JSON.stringify(session)); }
    function updateCoins(delta){ session.coins = Math.max(0,(session.coins||0)+delta); saveSession(); coinsLabel.textContent=session.coins; coinsLabel2.textContent=session.coins; }
    function genRef(){ return 'REF'+Math.random().toString(36).slice(2,8).toUpperCase(); }
    function isVIP(){ return membership && Date.now() < membership.until; }
    function setVIP(duration){
      const now = Date.now();
      const add = duration==='24h'? 24*3600e3 : duration==='7d'? 7*24*3600e3 : 30*24*3600e3;
      membership = { until: now + add };
      localStorage.setItem('membership', JSON.stringify(membership));
      paintVIP();
    }
    function paintVIP(){
      const active = isVIP();
      vipBadge.style.display = active ? 'inline-block' : 'none';
      vipEmojis.style.display = active ? 'flex' : 'none';
    }

    /* ================= BONO DIARIO ================= */
    const btnDaily = document.getElementById('btnDaily');
    btnDaily.onclick = ()=>{
      const today = new Date().toISOString().slice(0,10);
      const last = localStorage.getItem('lastDaily') || '';
      if(last===today){ alert('Ya reclamaste el bono diario hoy.'); return; }
      localStorage.setItem('lastDaily', today);
      updateCoins(DAILY_BONUS);
      alert(`+${DAILY_BONUS} monedas por ingreso diario üéÅ`);
    };

    /* ================= REFERIDOS ================= */
    document.getElementById('btnReferral').onclick = ()=> openModal('refModal');
    document.getElementById('btnCloseRef').onclick = ()=> closeModal('refModal');
    document.getElementById('myRefCode').textContent = session.refCode;
    document.getElementById('btnCopyRef').onclick = ()=> { navigator.clipboard.writeText(session.refCode); alert('C√≥digo copiado'); };
    document.getElementById('btnRedeemRef').onclick = ()=>{
      const code = (document.getElementById('refInput').value||'').trim().toUpperCase();
      if(!code || code===session.refCode){ alert('C√≥digo inv√°lido'); return; }
      const used = JSON.parse(localStorage.getItem('refUsed')||'[]');
      if(used.includes(code)){ alert('Ya usaste ese c√≥digo'); return; }
      // Marcamos como usado en este navegador (simple)
      used.push(code); localStorage.setItem('refUsed', JSON.stringify(used));
      updateCoins(REF_BONUS_GUEST);
      alert(`¬°C√≥digo canjeado! Ganaste +${REF_BONUS_GUEST} monedas.`);
      // Al due√±o no podemos abonarle sin backend; lo dejamos documentado.
    };

    /* ================= TIENDA / RECARGA / VIP ================= */
    document.getElementById('btnStore').onclick = ()=> openModal('storeModal');
    document.getElementById('btnCloseStore').onclick = ()=> closeModal('storeModal');

    // Compras r√°pidas (simuladas)
    document.getElementById('sBuy50').onclick = ()=>{ updateCoins(50); alert('Gracias por tu compra (50)'); };
    document.getElementById('sBuy150').onclick = ()=>{ updateCoins(150); alert('Gracias por tu compra (150)'); };
    document.getElementById('sBuy400').onclick = ()=>{ updateCoins(400); alert('Gracias por tu compra (400)'); };

    // Activar VIP desde tienda
    document.querySelectorAll('[data-vip2]').forEach(b=>{
      b.onclick = ()=>{ setVIP(b.dataset.vip2); alert('VIP activado üéâ'); closeModal('storeModal'); };
    });

    // Modal recarga (cuando no hay monedas)
    const rechargeModal = document.getElementById('rechargeModal');
    function openRecharge(){ rechargeModal.classList.add('show'); }
    document.getElementById('btnCloseModal').onclick = ()=> rechargeModal.classList.remove('show');
    document.getElementById('btnBuy20').onclick = ()=>{ updateCoins(20); rechargeModal.classList.remove('show'); };
    document.getElementById('btnBuy50').onclick = ()=>{ updateCoins(50); rechargeModal.classList.remove('show'); };
    document.getElementById('btnBuy100').onclick = ()=>{ updateCoins(100); rechargeModal.classList.remove('show'); };
    // VIP upsell dentro del modal
    document.querySelectorAll('[data-vip]').forEach(b=>{
      b.onclick = ()=>{ setVIP(b.dataset.vip); alert('VIP activado üéâ'); rechargeModal.classList.remove('show'); };
    });
    // Ver anuncio (+10)
    document.getElementById('btnWatchAd').onclick = ()=>{
      window.open(AD_POP_URL,'_blank'); // Pop-under/redirect
      updateCoins(10);
      rechargeModal.classList.remove('show');
    };

    // Abrir tienda desde header
    const btnStore = document.getElementById('btnStore');

    /* ================= INTERSTITIAL INPAGE (entrar/salir del chat) ================= */
    const inpage = document.getElementById('inpage');
    const closeInpage = document.getElementById('closeInpage');
    closeInpage.onclick = ()=> inpage.classList.remove('show');
    function showInPage(){ inpage.classList.add('show'); setTimeout(()=>inpage.classList.remove('show'), 6000); }

    /* ================= MODELOS DESDE FIRESTORE ================= */
    const chatList = document.getElementById('chatList');
    const slidesIntervals = {};
    let firstUserClickOpenedPop = false;

    async function renderModels(){
      chatList.innerHTML='';
      const snap = await getDocs(collection(db,"models"));
      snap.forEach(docSnap=>{
        const m={id:docSnap.id,...docSnap.data()};
        const card=document.createElement('div');
        card.className='model-card';

        const slideId='slide_'+m.id;
        const pub = (m.photos||[]).slice(0,3);
        const priv = (m.photos||[]).slice(3,5);

        card.innerHTML=`
          <div class="model-slideshow" id="${slideId}">
            ${pub.map((src,i)=>`<img src="${src}" class="${i===0?'active':''}">`).join('')}
          </div>
          <div class="info">
            <div class="name">${m.name} <span class="online">‚óè Online</span></div>
            <div class="extra">${m.age||'‚Äî'} a√±os ¬∑ ${m.country||'‚Äî'}</div>
            <div class="desc">${m.desc||''}</div>
          </div>
          <div class="actions">
            <button class="action-btn btn-like">
              <img src="https://qu.ax/hlsxX.png" alt="like"><span>Me gusta</span>
              <span class="like-badge">${m.likes||0}</span>
            </button>
            <button class="action-btn btn-priv">
              <img src="https://qu.ax/hlsxX.png" alt="priv"><span>Ver privadas</span>
            </button>
            <button class="action-btn btn-msg">
              <img src="https://qu.ax/jGSiu.png" alt="mensaje"><span>Mensaje</span>
            </button>
          </div>
        `;

        // Like (local persistente)
        card.querySelector('.btn-like').onclick=(e)=>{
          e.stopPropagation();
          const badge = card.querySelector('.like-badge');
          badge.textContent = String(parseInt(badge.textContent||'0')+1);
        };

        // Ver privadas -> solo VIP
        card.querySelector('.btn-priv').onclick=(e)=>{
          e.stopPropagation();
          if(!isVIP()){
            openRecharge(); // oferta VIP tambi√©n
            alert('Activa VIP para ver fotos privadas üíé');
            return;
          }
          // abrir un visor sencillo
          const w = window.open('','_blank','width=800,height=600');
          w.document.write('<title>Privadas</title>');
          (priv.length?priv:pub).forEach(src=>{
            w.document.write(`<img src="${src}" style="max-width:100%;display:block;margin-bottom:8px">`);
          });
        };

        // Abrir chat
        card.querySelector('.btn-msg').onclick=(e)=>{ e.stopPropagation(); openChatWith(m); };
        card.onclick=()=> openChatWith(m);

        chatList.appendChild(card);
        startSlideshow(slideId);
      });
    }

    function startSlideshow(id){
      const box=document.getElementById(id); if(!box) return;
      const imgs=[...box.querySelectorAll('img')]; if(imgs.length<=1) return;
      let i=0;
      if(slidesIntervals[id]) clearInterval(slidesIntervals[id]);
      slidesIntervals[id]=setInterval(()=>{
        imgs[i].classList.remove('active');
        i=(i+1)%imgs.length;
        imgs[i].classList.add('active');
      }, 2800);
    }

    /* ================= ROUTER ================= */
    const views={chat:'view-chat',conversation:'view-conversation'};
    function go(v){
      Object.values(views).forEach(id=>document.getElementById(id).classList.remove('active'));
      document.getElementById(views[v]).classList.add('active');
    }

    /* ================= CHAT ================= */
    let currentModel=null;
    const messages=document.getElementById('messages');
    const chatName=document.getElementById('chatName');
    const chatAvatar=document.getElementById('chatAvatar');
    const chatStatus=document.getElementById('chatStatus');
    const typingHint=document.getElementById('typingHint');

    // Emojis VIP insert
    document.querySelectorAll('#vipEmojis [data-emoji]').forEach(b=>{
      b.onclick=()=>{ const i=document.getElementById('msgText'); i.value += b.dataset.emoji; i.focus(); };
    });

    function openChatWith(m){
      currentModel=m;
      chatName.textContent=m.name;
      chatAvatar.src=(m.photos&&m.photos[0])||'';
      chatStatus.textContent='En l√≠nea';
      messages.innerHTML=`<div class="msg them">Holi üíï soy ${m.name}, ¬øquieres jugar?</div>`;
      go('conversation');

      // Interstitial InPage al entrar
      showInPage();

      // Pop-under en primer click del usuario (anti-bloqueo)
      if(!firstUserClickOpenedPop){
        const once = ()=>{ window.open(AD_POP_URL,'_blank'); firstUserClickOpenedPop=true; document.removeEventListener('click', once, true); };
        document.addEventListener('click', once, true);
      }
    }

    // Volver -> mostrar interstitial de salida
    document.getElementById('btnBack').onclick = ()=>{
      go('chat');
      showInPage();
    };

    // Enviar
    document.getElementById('btnSend').onclick=sendMsg;
    document.getElementById('msgText').addEventListener('keydown',e=>{ if(e.key==='Enter'){e.preventDefault();sendMsg();} });

    function sendMsg(){
      if(!currentModel) return;
      const input=document.getElementById('msgText');
      const val=(input.value||'').trim(); if(!val) return;

      // Si NO es VIP, cobrar; si no alcanza, abrir recarga
      if(!isVIP()){
        if((session.coins||0) < COIN_PER_MSG){ openRecharge(); return; }
        updateCoins(-COIN_PER_MSG);
      }

      const ts=Date.now();
      messages.innerHTML+=`<div class="msg you">${sanitize(val)}<div class="meta">${new Date(ts).toLocaleTimeString()} ¬∑ enviado</div></div>`;
      input.value='';

      // typing + visto + respuesta a los 3s
      typing(true);
      setTimeout(()=>{
        const metas=[...messages.querySelectorAll('.msg.you .meta')];
        if(metas.length){ metas[metas.length-1].textContent = `${new Date(ts).toLocaleTimeString()} ¬∑ visto`; }
        setTimeout(()=>{
          typing(false);
          autoReplyFromFlow();
        },3000);
      },500);

      // si el usuario deja de hablar 90s -> desconectado
      clearTimeout(window.__idleTimer);
      window.__idleTimer = setTimeout(()=> chatStatus.textContent='Desconectado', 90000);
    }

    function typing(on){ typingHint.classList.toggle('on', !!on); chatStatus.textContent = on?'En l√≠nea ¬∑ escribiendo‚Ä¶':'En l√≠nea'; }

    // Auto-reply desde config/autoFlow en Firestore (solo lectura simple en esta versi√≥n)
    async function autoReplyFromFlow(){
      // Puedes cargar flujo desde Firestore config/autoFlow si lo necesitas
      const fallback = "Estoy aqu√≠ para ti üíñ";
      messages.innerHTML+=`<div class="msg them">${sanitize(fallback)}<div class="meta">${new Date().toLocaleTimeString()}</div></div>`;
    }

    /* ================= UTIL ================= */
    function openModal(id){ document.getElementById(id).classList.add('show'); }
    function closeModal(id){ document.getElementById(id).classList.remove('show'); }
    function sanitize(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

    // Abrir tienda desde header
    btnStore.onclick = ()=> openModal('storeModal');

    // Cerrar referidos si clic fuera
    ['storeModal','refModal','rechargeModal'].forEach(id=>{
      document.getElementById(id).addEventListener('click',e=>{ if(e.target.id===id) e.target.classList.remove('show'); });
    });

    /* INIT */
    renderModels();
  </script>
</body>
</html>
